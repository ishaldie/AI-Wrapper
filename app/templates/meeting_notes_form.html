{% extends "base.html" %}

{% block title %}Meeting Notes â€” AI Wrappers{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="/" class="text-blue-600 hover:text-blue-800 text-sm">&larr; Back to documents</a>
</div>

<h1 class="text-2xl font-bold text-gray-800 mb-2">Meeting Notes</h1>
<p class="text-gray-600 mb-6">Fill in the details below and we'll generate polished meeting notes for you.</p>

<form id="meeting-form" class="space-y-5 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <div>
        <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Meeting Title *</label>
        <input type="text" id="title" name="title" required maxlength="200"
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
               placeholder="e.g., Q1 Strategy Review">
    </div>

    <div>
        <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
        <input type="date" id="date" name="date" required
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
    </div>

    <div>
        <label for="attendees" class="block text-sm font-medium text-gray-700 mb-1">Attendees *</label>
        <input type="text" id="attendees" name="attendees" required
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
               placeholder="e.g., Alice Johnson, Bob Smith, Carol Davis">
    </div>

    <div>
        <label for="agenda" class="block text-sm font-medium text-gray-700 mb-1">Agenda</label>
        <textarea id="agenda" name="agenda" rows="3" maxlength="2000"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="List the main agenda items..."></textarea>
    </div>

    <div>
        <label for="discussion_points" class="block text-sm font-medium text-gray-700 mb-1">Key Discussion Points *</label>
        <textarea id="discussion_points" name="discussion_points" rows="5" required maxlength="5000"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Describe what was discussed, decisions made, key takeaways..."></textarea>
    </div>

    <div>
        <label for="action_items" class="block text-sm font-medium text-gray-700 mb-1">Action Items</label>
        <textarea id="action_items" name="action_items" rows="3" maxlength="2000"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="e.g., Alice to send follow-up email by Friday..."></textarea>
    </div>

    <div>
        <label for="tone" class="block text-sm font-medium text-gray-700 mb-1">Tone</label>
        <select id="tone" name="tone"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="formal">Formal</option>
            <option value="casual">Casual</option>
        </select>
    </div>

    <button type="submit" id="submit-btn"
            class="w-full bg-blue-600 text-white py-3 px-4 rounded-md font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
        Generate Meeting Notes
    </button>
</form>

<!-- Result container (hidden initially) -->
<div id="result-container" class="mt-8 hidden">
    <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold text-gray-800">Generated Meeting Notes</h2>
        <button id="copy-btn" onclick="copyToClipboard()"
                class="px-4 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 border border-gray-300 transition-colors">
            Copy to Clipboard
        </button>
    </div>
    <div id="output" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 prose max-w-none whitespace-pre-wrap font-mono text-sm"></div>
</div>

<!-- Loading indicator -->
<div id="loading" class="mt-8 hidden text-center">
    <div class="inline-flex items-center gap-2 text-blue-600">
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Generating your meeting notes...</span>
    </div>
</div>

<!-- Error container -->
<div id="error-container" class="mt-8 hidden">
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <p class="text-red-700" id="error-message"></p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('meeting-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const submitBtn = document.getElementById('submit-btn');
    const loading = document.getElementById('loading');
    const resultContainer = document.getElementById('result-container');
    const output = document.getElementById('output');
    const errorContainer = document.getElementById('error-container');

    // Collect form data
    const data = {
        title: form.title.value,
        date: form.date.value,
        attendees: form.attendees.value,
        agenda: form.agenda.value,
        discussion_points: form.discussion_points.value,
        action_items: form.action_items.value,
        tone: form.tone.value
    };

    // Reset UI
    submitBtn.disabled = true;
    submitBtn.textContent = 'Generating...';
    loading.classList.remove('hidden');
    resultContainer.classList.add('hidden');
    errorContainer.classList.add('hidden');
    output.textContent = '';

    try {
        const response = await fetch('/api/generate/meeting-notes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.detail || 'Generation failed');
        }

        loading.classList.add('hidden');
        resultContainer.classList.remove('hidden');

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const text = decoder.decode(value);
            const lines = text.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const content = line.slice(6);
                    if (content === '[DONE]') continue;
                    if (content.startsWith('[ERROR]')) {
                        throw new Error(content.slice(8));
                    }
                    output.textContent += content;
                }
            }
        }
    } catch (error) {
        loading.classList.add('hidden');
        resultContainer.classList.add('hidden');
        errorContainer.classList.remove('hidden');
        document.getElementById('error-message').textContent = error.message;
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Generate Meeting Notes';
    }
});

function copyToClipboard() {
    const output = document.getElementById('output');
    const btn = document.getElementById('copy-btn');
    navigator.clipboard.writeText(output.textContent).then(() => {
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = 'Copy to Clipboard'; }, 2000);
    });
}
</script>
{% endblock %}
