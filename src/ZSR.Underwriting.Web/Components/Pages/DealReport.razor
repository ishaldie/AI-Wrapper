@page "/deals/{DealId:guid}/report"
@using ZSR.Underwriting.Application.DTOs.Report
@using ZSR.Underwriting.Application.Interfaces
@using ZSR.Underwriting.Domain.Enums
@inject IReportAssembler ReportAssembler
@inject IActivityTracker ActivityTracker
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Report - Underwriting Analyst</PageTitle>

<div class="animate-in" style="max-width: 1200px;">
    @if (_loading)
    {
        <MudPaper Elevation="0" Class="card-elevated pa-8 mt-8" Style="text-align: center; max-width: 500px; margin-left: auto; margin-right: auto;">
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
            <MudText Typo="Typo.h6" Class="mt-4" Style="color: #1A2332; font-weight: 600;">
                Generating Report
            </MudText>
            <MudText Typo="Typo.body2" Class="mt-1" Style="color: #6B7280;">
                Running calculations, fetching market data, and generating AI analysis.
                This may take 30-60 seconds.
            </MudText>
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mt-4" Rounded="true" />
            <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ArrowBack"
                       OnClick="@(() => Navigation.NavigateTo($"/deals/{DealId}"))"
                       Class="mt-4"
                       Style="text-transform: none; color: #6B7280;">
                Back to Deal
            </MudButton>
        </MudPaper>
    }
    else if (_error != null)
    {
        <MudPaper Elevation="0" Class="card-elevated pa-8" Style="text-align: center;">
            <MudIcon Icon="@Icons.Material.Outlined.ErrorOutline" Size="Size.Large"
                     Style="color: #EF4444;" />
            <MudText Typo="Typo.h6" Class="mt-2" Style="color: #1A1D23;">
                Report unavailable
            </MudText>
            <MudText Typo="Typo.body2" Class="mt-1" Style="color: #6B7280;">
                @_error
            </MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       Href="/search" Class="mt-4"
                       Style="text-transform: none; border-radius: 12px;">
                Back to Dashboard
            </MudButton>
        </MudPaper>
    }
    else if (_report != null)
    {
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
            <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ArrowBack"
                       Href="/search"
                       Style="text-transform: none; color: #6B7280;">
                Dashboard
            </MudButton>
        </MudStack>

        <ReportViewer Report="@_report" />
    }
</div>

@code {
    [Parameter] public Guid DealId { get; set; }

    private UnderwritingReportDto? _report;
    private bool _loading = true;
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _report = await ReportAssembler.AssembleReportAsync(DealId);
            await ActivityTracker.TrackEventAsync(ActivityEventType.ReportViewed, dealId: DealId);
            await ActivityTracker.TrackEventAsync(ActivityEventType.WizardCompleted, dealId: DealId);
        }
        catch (KeyNotFoundException)
        {
            _error = "Deal not found. It may have been deleted.";
        }
        catch (Exception)
        {
            _error = "An error occurred while loading the report.";
        }
        finally
        {
            _loading = false;
        }
    }
}
