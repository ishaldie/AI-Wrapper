@page "/search"
@using ZSR.Underwriting.Application.DTOs
@using ZSR.Underwriting.Application.Interfaces
@using ZSR.Underwriting.Domain.Enums
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IDealService DealService
@inject AuthenticationStateProvider AuthStateProvider
@inject IQuickAnalysisService QuickAnalysisService
@inject IActivityTracker ActivityTracker
@inject NavigationManager Navigation
@inject ILogger<Dashboard> Logger
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<PageTitle>Dashboard - Underwriting Analyst</PageTitle>

<div class="animate-in" style="max-width: 960px;">
    <AuthorizeView>
        <Authorized>
            <MudText Typo="Typo.body1" Style="color: #6B7280; margin-bottom: 0.25rem;">
                Welcome back, @GetFirstName(context.User.Identity?.Name)
            </MudText>
        </Authorized>
    </AuthorizeView>

    <MudText Typo="Typo.h3" Style="color: #1A1D23; margin-bottom: 1.5rem; font-weight: 800;">
        Start a new analysis
    </MudText>

    @* Search bar *@
    <div style="margin-bottom: 2.5rem;">
        <div class="search-bar">
            <input type="text" placeholder="Enter a property name or address for instant analysis..."
                   @bind="_searchQuery" @bind:event="oninput" @onkeydown="HandleSearchKeyDown"
                   disabled="@_analyzing" />
            <button class="search-bar-btn" type="button" @onclick="HandleSearch"
                    disabled="@_analyzing">
                @if (_analyzing)
                {
                    <MudProgressCircular Indeterminate="true" Size="Size.Small"
                                         Style="width: 18px; height: 18px; color: #fff;" />
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" />
                }
            </button>
        </div>
        <MudText Typo="Typo.caption" Style="color: #9CA3AF; margin-top: 0.5rem;">
            The more info you provide, the better the analysis.
            You can also attach rent rolls, T12s, and other documents in the chat.
        </MudText>
    </div>

    @* Recommended section *@
    <MudText Typo="Typo.h6" Style="color: #1A1D23; margin-bottom: 1rem;">
        Recommended for you
    </MudText>

    <MudGrid Spacing="3" Class="mb-6">
        <MudItem xs="12" sm="4">
            <div class="rec-card animate-in delay-1" style="cursor: pointer;" @onclick="NavigateToNewAnalysis">
                <MudStack Spacing="2">
                    <MudChip T="string" Size="Size.Small" Style="background: #EFF6FF; color: #2563EB; font-weight: 600;">
                        New
                    </MudChip>
                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                        Underwrite a deal
                    </MudText>
                    <MudText Typo="Typo.body2" Style="color: #6B7280;">
                        Start a new multifamily acquisition analysis with AI-powered insights.
                    </MudText>
                </MudStack>
            </div>
        </MudItem>
        <MudItem xs="12" sm="4">
            <div class="rec-card animate-in delay-2" style="cursor: pointer;" @onclick="NavigateToNewAnalysis">
                <MudStack Spacing="2">
                    <MudChip T="string" Size="Size.Small" Style="background: #FEF3C7; color: #D97706; font-weight: 600;">
                        Trending
                    </MudChip>
                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                        Market analysis
                    </MudText>
                    <MudText Typo="Typo.body2" Style="color: #6B7280;">
                        Explore market trends, comps, and submarket data for any metro area.
                    </MudText>
                </MudStack>
            </div>
        </MudItem>
        <MudItem xs="12" sm="4">
            <div class="rec-card animate-in delay-3" style="cursor: pointer;" @onclick="NavigateToDeals">
                <MudStack Spacing="2">
                    <MudChip T="string" Size="Size.Small" Style="background: #F0FDF4; color: #16A34A; font-weight: 600;">
                        For you
                    </MudChip>
                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                        Review recent work
                    </MudText>
                    <MudText Typo="Typo.body2" Style="color: #6B7280;">
                        Pick up where you left off with your most recent analyses.
                    </MudText>
                </MudStack>
            </div>
        </MudItem>
    </MudGrid>

    @* Your analyses section *@
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
        <MudText Typo="Typo.h6" Style="color: #1A1D23;">
            Your analyses
        </MudText>
        <MudButton Variant="Variant.Text" Href="/deals"
                   EndIcon="@Icons.Material.Filled.ArrowForward"
                   Style="text-transform: none; font-weight: 600; font-size: 0.8125rem; color: #F97316;">
            View All
        </MudButton>
    </MudStack>

    @if (_loading)
    {
        <MudStack AlignItems="AlignItems.Center" Class="pa-8">
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
        </MudStack>
    }
    else if (_deals.Count == 0)
    {
        <MudPaper Elevation="0" Class="card-elevated pa-8" Style="text-align: center;">
            <MudIcon Icon="@Icons.Material.Outlined.FolderOpen" Size="Size.Medium"
                     Style="color: #D1D5DB;" />
            <MudText Typo="Typo.body1" Style="color: #6B7280; margin-top: 0.5rem;">
                No analyses yet. Start your first deal to see it here.
            </MudText>
        </MudPaper>
    }
    else
    {
        <MudDataGrid Items="@_deals" Dense="true" Hover="true" Bordered="false"
                     RowClick="@((DataGridRowClickEventArgs<DealSummaryDto> args) => Navigation.NavigateTo($"/deals/{args.Item.Id}"))"
                     RowStyle="cursor: pointer;"
                     Style="background: #FFFFFF; border-radius: 12px; border: 1px solid #E5E7EB;">
            <Columns>
                <PropertyColumn Property="x => x.PropertyName" Title="NAME" />
                <TemplateColumn Title="STATUS">
                    <CellTemplate>
                        <MudChip T="string" Size="Size.Small"
                                 Color="@GetStatusColor(context.Item.Status)"
                                 Variant="Variant.Filled">
                            @context.Item.Status
                        </MudChip>
                    </CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="x => x.Address" Title="ADDRESS" />
                <TemplateColumn Title="LAST MODIFIED">
                    <CellTemplate>
                        @context.Item.UpdatedAt.ToString("MMM d, yyyy")
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>
    }
</div>

@code {
    [SupplyParameterFromQuery(Name = "q")]
    private string? InitialQuery { get; set; }

    private bool _loading = true;
    private bool _analyzing;
    private List<DealSummaryDto> _deals = new();
    private string _searchQuery = "";
    private bool _autoSearchTriggered;
    private string _userId = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        _userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier) ?? string.Empty;
        var deals = await DealService.GetAllDealsAsync(_userId);
        _deals = deals.ToList();
        _loading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !string.IsNullOrWhiteSpace(InitialQuery) && !_autoSearchTriggered)
        {
            _autoSearchTriggered = true;
            _searchQuery = InitialQuery;
            StateHasChanged();
            await HandleSearch();
        }
    }

    private static string GetFirstName(string? name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "there";
        var parts = name.Trim().Split(' ');
        return parts[0];
    }

    private async Task HandleSearch()
    {
        if (string.IsNullOrWhiteSpace(_searchQuery))
        {
            return;
        }

        _analyzing = true;
        try
        {
            await ActivityTracker.TrackEventAsync(ActivityEventType.SearchPerformed, metadata: _searchQuery);
            var progress = await QuickAnalysisService.StartAnalysisAsync(_searchQuery, _userId);
            await ActivityTracker.TrackEventAsync(ActivityEventType.QuickAnalysisStarted, dealId: progress.DealId);
            Navigation.NavigateTo($"/deals/{progress.DealId}?tab=chat");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "QuickAnalysis failed for query '{Query}', falling back to wizard", _searchQuery);
            Snackbar.Add("Analysis failed. Please try again.", Severity.Error);
        }
        finally
        {
            _analyzing = false;
        }
    }

    private async Task HandleSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await HandleSearch();
    }

    private void NavigateToNewAnalysis()
    {
        Navigation.NavigateTo("/analysis/start");
    }

    private void NavigateToDeals()
    {
        Navigation.NavigateTo("/deals");
    }

    private static Color GetStatusColor(string status) => status switch
    {
        "Draft" => Color.Default,
        "InProgress" => Color.Warning,
        "Complete" => Color.Success,
        "Archived" => Color.Dark,
        _ => Color.Default
    };
}
