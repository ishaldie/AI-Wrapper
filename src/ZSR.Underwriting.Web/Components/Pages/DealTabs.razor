@page "/deals/{DealId:guid}"
@using ZSR.Underwriting.Domain.Entities
@using ZSR.Underwriting.Domain.Enums
@using ZSR.Underwriting.Infrastructure.Data
@using Microsoft.EntityFrameworkCore
@inject AppDbContext Db
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>@(_deal?.PropertyName ?? "Deal") - Underwriting Analyst</PageTitle>

@if (_loading)
{
    <MudStack AlignItems="AlignItems.Center" Class="pa-8">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    </MudStack>
}
else if (_deal is null)
{
    <MudStack AlignItems="AlignItems.Center" Spacing="4" Class="pa-8">
        <MudIcon Icon="@Icons.Material.Outlined.SearchOff" Size="Size.Large" Style="color: #D1D5DB;" />
        <MudText Typo="Typo.h6" Style="color: #6B7280;">Deal not found</MudText>
        <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.ArrowBack"
                   OnClick="@(() => Navigation.NavigateTo("/deals"))"
                   Style="text-transform: none;">
            Back to Pipeline
        </MudButton>
    </MudStack>
}
else
{
    <div class="deal-tabs-header">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                       OnClick="@(() => Navigation.NavigateTo("/deals"))"
                       Style="color: #6B7280;" />
        <div style="flex: 1; min-width: 0;">
            <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1A2332; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                @_deal.PropertyName
            </MudText>
            <MudText Typo="Typo.body2" Style="color: #6B7280;">
                @_deal.Address
            </MudText>
        </div>
        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(_deal.Status.ToString())">
            @_deal.Status
        </MudChip>
    </div>

    <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" Class="deal-tabs-container"
             PanelClass="deal-tab-panel" KeepPanelsAlive="true"
             ActivePanelIndex="_activePanelIndex" ActivePanelIndexChanged="OnTabChanged">
        <MudTabPanel Text="General" Icon="@Icons.Material.Filled.Info">
            <div class="deal-tab-content">
                <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight: 600; color: #1A2332;">Property Information</MudText>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_deal.PropertyName" Label="Property Name" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_deal.Address" Label="Address" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudNumericField @bind-Value="_deal.UnitCount" Label="Unit Count" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudNumericField @bind-Value="_property.YearBuilt" Label="Year Built" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudTextField @bind-Value="_property.BuildingType" Label="Building Type" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudNumericField @bind-Value="_property.SquareFootage" Label="Square Footage" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudNumericField @bind-Value="_property.Acreage" Label="Acreage" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudNumericField @bind-Value="_deal.PurchasePrice" Label="Purchase Price" Variant="Variant.Outlined"
                                         Format="N0" Adornment="Adornment.Start" AdornmentText="$" />
                    </MudItem>
                </MudGrid>

                <MudText Typo="Typo.h6" Class="mt-6 mb-4" Style="font-weight: 600; color: #1A2332;">Deal Classification</MudText>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudSelect @bind-Value="_deal.ExecutionType" Label="Execution Type" Variant="Variant.Outlined">
                            @foreach (var et in Enum.GetValues<ExecutionType>())
                            {
                                <MudSelectItem Value="@et">@et</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_deal.TransactionType" Label="Transaction Type" Variant="Variant.Outlined" />
                    </MudItem>
                </MudGrid>

                <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-6">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Save"
                               OnClick="SaveGeneralAsync"
                               Disabled="_saving"
                               Style="text-transform: none; font-weight: 500;">
                        @(_saving ? "Saving..." : "Save Changes")
                    </MudButton>
                </MudStack>
            </div>
        </MudTabPanel>

        <MudTabPanel Text="Underwriting" Icon="@Icons.Material.Filled.Analytics">
            <div class="deal-tab-content">
                @if (_calc is null)
                {
                    <MudAlert Severity="Severity.Info" Class="mb-4">
                        Underwriting metrics will appear here as the AI analyzes your deal.
                    </MudAlert>
                }
                else
                {
                    @* NOI Breakdown *@
                    <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #1A2332;">NOI Breakdown</MudText>
                    <MudSimpleTable Dense="true" Hover="true" Elevation="0" Style="border: 1px solid #E5E7EB; border-radius: 8px; margin-bottom: 1.5rem;">
                        <tbody>
                            <tr><td>Gross Potential Rent</td><td style="text-align: right;">@FormatCurrency(_calc.GrossPotentialRent)</td></tr>
                            <tr><td>Vacancy Loss</td><td style="text-align: right; color: #DC2626;">@FormatCurrencyNeg(_calc.VacancyLoss)</td></tr>
                            <tr><td>Effective Gross Income</td><td style="text-align: right;">@FormatCurrency(_calc.EffectiveGrossIncome)</td></tr>
                            <tr><td>Other Income</td><td style="text-align: right;">@FormatCurrency(_calc.OtherIncome)</td></tr>
                            <tr><td>Operating Expenses</td><td style="text-align: right; color: #DC2626;">@FormatCurrencyNeg(_calc.OperatingExpenses)</td></tr>
                            <tr style="font-weight: 700; background: #F9FAFB;"><td>Net Operating Income</td><td style="text-align: right;">@FormatCurrency(_calc.NetOperatingIncome)</td></tr>
                        </tbody>
                    </MudSimpleTable>

                    @* Key Metrics *@
                    <MudGrid Class="mb-6">
                        <MudItem xs="12" md="4">
                            <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                                <MudText Typo="Typo.caption" Style="color: #6B7280;">Going-In Cap Rate</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1A2332;">@FormatPercent(_calc.GoingInCapRate)</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                                <MudText Typo="Typo.caption" Style="color: #6B7280;">Exit Cap Rate</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1A2332;">@FormatPercent(_calc.ExitCapRate)</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                                <MudText Typo="Typo.caption" Style="color: #6B7280;">Price Per Unit</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1A2332;">@FormatCurrency(_calc.PricePerUnit)</MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>

                    @* Return Metrics *@
                    <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #1A2332;">Return Metrics</MudText>
                    <MudGrid Class="mb-6">
                        <MudItem xs="12" md="4">
                            <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                                <MudText Typo="Typo.caption" Style="color: #6B7280;">Cash-on-Cash Return</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1A2332;">@FormatPercent(_calc.CashOnCashReturn)</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                                <MudText Typo="Typo.caption" Style="color: #6B7280;">IRR</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1A2332;">@FormatPercent(_calc.InternalRateOfReturn)</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                                <MudText Typo="Typo.caption" Style="color: #6B7280;">Equity Multiple</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1A2332;">@FormatMultiple(_calc.EquityMultiple)</MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>

                    @* Debt Metrics *@
                    <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #1A2332;">Debt Metrics</MudText>
                    <MudSimpleTable Dense="true" Hover="true" Elevation="0" Style="border: 1px solid #E5E7EB; border-radius: 8px; margin-bottom: 1.5rem;">
                        <tbody>
                            <tr><td>Loan Amount</td><td style="text-align: right;">@FormatCurrency(_calc.LoanAmount)</td></tr>
                            <tr><td>Annual Debt Service</td><td style="text-align: right;">@FormatCurrency(_calc.AnnualDebtService)</td></tr>
                            <tr><td>DSCR</td><td style="text-align: right;">@FormatMultiple(_calc.DebtServiceCoverageRatio)</td></tr>
                        </tbody>
                    </MudSimpleTable>
                }

                @* Capital Stack *@
                <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #1A2332;">Capital Stack</MudText>
                <MudTable Items="_capitalStack" Dense="true" Hover="true" Elevation="0"
                          Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                    <HeaderContent>
                        <MudTh>Source</MudTh>
                        <MudTh Style="text-align: right;">Amount</MudTh>
                        <MudTh Style="text-align: right;">Rate</MudTh>
                        <MudTh Style="text-align: right;">Term (Yrs)</MudTh>
                        <MudTh Style="text-align: center;">Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.Source</MudTd>
                        <MudTd Style="text-align: right;">@FormatCurrency(context.Amount)</MudTd>
                        <MudTd Style="text-align: right;">@FormatPercent(context.Rate)</MudTd>
                        <MudTd Style="text-align: right;">@(context.TermYears?.ToString() ?? "\u2014")</MudTd>
                        <MudTd Style="text-align: center;">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                           OnClick="@(() => RemoveCapitalStackItem(context))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>

                @* Summary totals *@
                <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-3 px-4">
                    <MudText Typo="Typo.body1" Style="font-weight: 600;">Total Sources</MudText>
                    <MudText Typo="Typo.body1" Style="font-weight: 700;">@FormatCurrency(_capitalStack.Sum(c => c.Amount))</MudText>
                </MudStack>
                @if (_deal!.PurchasePrice > 0)
                {
                    <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-1 px-4">
                        <MudText Typo="Typo.body1" Style="font-weight: 600;">Equity Required</MudText>
                        <MudText Typo="Typo.body1" Style="font-weight: 700; color: #F97316;">
                            @FormatCurrency(_deal.PurchasePrice - _capitalStack.Where(c => c.Source == CapitalSource.SeniorDebt || c.Source == CapitalSource.Mezzanine).Sum(c => c.Amount))
                        </MudText>
                    </MudStack>
                }

                @* Add new capital stack item *@
                <MudStack Row="true" AlignItems="AlignItems.Center" Class="mt-4" Spacing="2">
                    <MudSelect @bind-Value="_newCapSource" Label="Source" Variant="Variant.Outlined" Style="max-width: 200px;">
                        @foreach (var cs in Enum.GetValues<CapitalSource>())
                        {
                            <MudSelectItem Value="@cs">@cs</MudSelectItem>
                        }
                    </MudSelect>
                    <MudNumericField @bind-Value="_newCapAmount" Label="Amount" Variant="Variant.Outlined"
                                     Adornment="Adornment.Start" AdornmentText="$" Format="N0" Style="max-width: 200px;" />
                    <MudNumericField @bind-Value="_newCapRate" Label="Rate %" Variant="Variant.Outlined" Style="max-width: 120px;" />
                    <MudNumericField @bind-Value="_newCapTerm" Label="Term" Variant="Variant.Outlined" Style="max-width: 100px;" />
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Add"
                               OnClick="AddCapitalStackItem"
                               Style="text-transform: none; font-weight: 500;">
                        Add
                    </MudButton>
                </MudStack>
            </div>
        </MudTabPanel>

        <MudTabPanel Text="Investors" Icon="@Icons.Material.Filled.People">
            <div class="deal-tab-content">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Typo="Typo.h6" Style="font-weight: 600; color: #1A2332;">
                        Investors (@_investors.Count)
                    </MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.PersonAdd"
                               OnClick="OpenAddInvestorDialog"
                               Style="text-transform: none; font-weight: 500;">
                        Add Investor
                    </MudButton>
                </MudStack>

                @if (!_investors.Any())
                {
                    <MudPaper Elevation="0" Class="pa-8" Style="text-align: center; border: 1px solid #E5E7EB; border-radius: 8px;">
                        <MudIcon Icon="@Icons.Material.Outlined.PersonOff" Size="Size.Large" Style="color: #D1D5DB;" />
                        <MudText Typo="Typo.body1" Style="color: #6B7280; margin-top: 0.5rem;">
                            No investors added yet. Click "Add Investor" to get started.
                        </MudText>
                    </MudPaper>
                }
                else
                {
                    <MudTable Items="_investors" Dense="true" Hover="true" Elevation="0"
                              Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                        <HeaderContent>
                            <MudTh>Name</MudTh>
                            <MudTh>Company</MudTh>
                            <MudTh>Role</MudTh>
                            <MudTh>Email</MudTh>
                            <MudTh>Phone</MudTh>
                            <MudTh Style="text-align: right;">Net Worth</MudTh>
                            <MudTh Style="text-align: right;">Liquidity</MudTh>
                            <MudTh Style="text-align: center;">Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Name</MudTd>
                            <MudTd>@(context.Company ?? "\u2014")</MudTd>
                            <MudTd>@(context.Role ?? "\u2014")</MudTd>
                            <MudTd>@(context.Email ?? "\u2014")</MudTd>
                            <MudTd>@(context.Phone ?? "\u2014")</MudTd>
                            <MudTd Style="text-align: right;">@FormatCurrency(context.NetWorth)</MudTd>
                            <MudTd Style="text-align: right;">@FormatCurrency(context.Liquidity)</MudTd>
                            <MudTd Style="text-align: center;">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary"
                                               OnClick="@(() => OpenEditInvestorDialog(context))" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                               OnClick="@(() => DeleteInvestor(context))" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }

                @* Add/Edit Investor Inline Form *@
                @if (_showInvestorForm)
                {
                    <MudPaper Elevation="2" Class="pa-4 mt-4" Style="border-radius: 8px;">
                        <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #1A2332;">
                            @(_editingInvestorId.HasValue ? "Edit Investor" : "New Investor")
                        </MudText>
                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="_invName" Label="Name" Variant="Variant.Outlined" Required="true" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="_invCompany" Label="Company" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudTextField @bind-Value="_invRole" Label="Role" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudTextField @bind-Value="_invEmail" Label="Email" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudTextField @bind-Value="_invPhone" Label="Phone" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudTextField @bind-Value="_invAddress" Label="Address" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="3">
                                <MudTextField @bind-Value="_invCity" Label="City" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="2">
                                <MudTextField @bind-Value="_invState" Label="State" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="3">
                                <MudTextField @bind-Value="_invZip" Label="Zip" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_invNetWorth" Label="Net Worth" Variant="Variant.Outlined"
                                                 Adornment="Adornment.Start" AdornmentText="$" Format="N0" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_invLiquidity" Label="Liquidity" Variant="Variant.Outlined"
                                                 Adornment="Adornment.Start" AdornmentText="$" Format="N0" />
                            </MudItem>
                            <MudItem xs="12">
                                <MudTextField @bind-Value="_invNotes" Label="Notes" Variant="Variant.Outlined" Lines="2" />
                            </MudItem>
                        </MudGrid>
                        <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-3" Spacing="2">
                            <MudButton Variant="Variant.Text" OnClick="CancelInvestorForm" Style="text-transform: none;">Cancel</MudButton>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Save"
                                       OnClick="SaveInvestor"
                                       Style="text-transform: none; font-weight: 500;">
                                @(_editingInvestorId.HasValue ? "Update" : "Save")
                            </MudButton>
                        </MudStack>
                    </MudPaper>
                }
            </div>
        </MudTabPanel>

        <MudTabPanel Text="Checklist" Icon="@Icons.Material.Filled.Checklist">
            <div class="deal-tab-content">
                @* Progress summary *@
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Typo="Typo.h6" Style="font-weight: 600; color: #1A2332;">Due Diligence Checklist</MudText>
                    <MudText Typo="Typo.body2" Style="color: #6B7280; font-weight: 500;">
                        @($"{_checklistItems.Count(i => i.Status == ChecklistStatus.Satisfied)} / {_checklistItems.Count} satisfied")
                    </MudText>
                </MudStack>

                @foreach (var grp in _checklistItems
                    .GroupBy(i => i.Template.Section)
                    .OrderBy(g => g.First().Template.SectionOrder))
                {
                    <MudText Typo="Typo.subtitle1" Class="mt-4 mb-2" Style="font-weight: 600; color: #374151;">
                        @grp.Key
                    </MudText>

                    @foreach (var item in grp.OrderBy(i => i.Template.SortOrder))
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2 pa-2"
                                  Style="border: 1px solid #E5E7EB; border-radius: 8px; background: #FFFFFF;">
                            <MudChip T="string" Size="Size.Small" Color="@GetChecklistStatusColor(item.Status)"
                                     Style="min-width: 120px; text-align: center;">
                                @FormatChecklistStatus(item.Status)
                            </MudChip>
                            <MudText Style="flex: 1; color: #1A2332;">@item.Template.ItemName</MudText>
                            @if (item.DocumentId != null)
                            {
                                <MudTooltip Text="@($"Download: {item.Document?.FileName ?? "document"}")">
                                    <MudIconButton Icon="@Icons.Material.Filled.Download"
                                                   Size="Size.Small" Color="Color.Primary"
                                                   Href="@($"/api/documents/{item.DocumentId}/download")"
                                                   Target="_blank" />
                                </MudTooltip>
                            }
                            <MudSelect T="ChecklistStatus" Value="item.Status"
                                       ValueChanged="@(val => UpdateChecklistStatus(item, val))"
                                       Variant="Variant.Outlined" Dense="true"
                                       Style="max-width: 180px;">
                                @foreach (var s in Enum.GetValues<ChecklistStatus>())
                                {
                                    <MudSelectItem Value="@s">@FormatChecklistStatus(s)</MudSelectItem>
                                }
                            </MudSelect>
                        </MudStack>
                    }
                }

                @if (!_checklistItems.Any())
                {
                    <MudAlert Severity="Severity.Info">No checklist items for this deal's execution type.</MudAlert>
                }
            </div>
        </MudTabPanel>

        <MudTabPanel Text="Documents" Icon="@Icons.Material.Filled.FolderOpen">
            <div class="deal-tab-content">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Typo="Typo.h6" Style="font-weight: 600; color: #1A2332;">
                        Documents (@_documents.Count)
                    </MudText>
                </MudStack>

                @if (!_documents.Any())
                {
                    <MudPaper Elevation="0" Class="pa-8" Style="text-align: center; border: 1px solid #E5E7EB; border-radius: 8px;">
                        <MudIcon Icon="@Icons.Material.Outlined.FolderOff" Size="Size.Large" Style="color: #D1D5DB;" />
                        <MudText Typo="Typo.body1" Style="color: #6B7280; margin-top: 0.5rem;">
                            No documents uploaded yet. Upload files via the Chat tab.
                        </MudText>
                    </MudPaper>
                }
                else
                {
                    <MudTable Items="_documents" Dense="true" Hover="true" Elevation="0"
                              Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                        <HeaderContent>
                            <MudTh>File Name</MudTh>
                            <MudTh>Type</MudTh>
                            <MudTh>Size</MudTh>
                            <MudTh>Uploaded</MudTh>
                            <MudTh Style="text-align: center;">Download</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@GetDocIcon(context.FileName)" Size="Size.Small" Style="color: #F97316;" />
                                    <span>@context.FileName</span>
                                </MudStack>
                            </MudTd>
                            <MudTd>@context.DocumentType</MudTd>
                            <MudTd>@FormatFileSize(context.FileSize)</MudTd>
                            <MudTd>@context.UploadedAt.ToString("MMM dd, yyyy h:mm tt")</MudTd>
                            <MudTd Style="text-align: center;">
                                <MudIconButton Icon="@Icons.Material.Filled.Download"
                                               Size="Size.Small" Color="Color.Primary"
                                               Href="@($"/api/documents/{context.Id}/download")"
                                               Target="_blank" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </div>
        </MudTabPanel>

        <MudTabPanel Text="Chat" Icon="@Icons.Material.Filled.Chat">
            @if (_activePanelIndex == 5)
            {
                <DealChatTab DealId="DealId" OnDealUpdated="RefreshDealData" />
            }
        </MudTabPanel>
    </MudTabs>
}

@code {
    [Parameter] public Guid DealId { get; set; }
    [SupplyParameterFromQuery(Name = "tab")]
    public string? Tab { get; set; }

    private Deal? _deal;
    private Property _property = null!;
    private CalculationResult? _calc;
    private List<CapitalStackItem> _capitalStack = new();
    private List<DealChecklistItem> _checklistItems = new();
    private List<UploadedDocument> _documents = new();
    private List<DealInvestor> _investors = new();
    private bool _loading = true;
    private bool _saving;
    private int _activePanelIndex;

    // New capital stack item form
    private CapitalSource _newCapSource = CapitalSource.SeniorDebt;
    private decimal _newCapAmount;
    private decimal? _newCapRate;
    private int? _newCapTerm;

    // Investor form
    private bool _showInvestorForm;
    private Guid? _editingInvestorId;
    private string _invName = "";
    private string? _invCompany;
    private string? _invRole;
    private string? _invEmail;
    private string? _invPhone;
    private string? _invAddress;
    private string? _invCity;
    private string? _invState;
    private string? _invZip;
    private decimal? _invNetWorth;
    private decimal? _invLiquidity;
    private string? _invNotes;

    protected override async Task OnInitializedAsync()
    {
        _deal = await Db.Deals
            .Include(d => d.Property)
            .Include(d => d.CalculationResult)
            .Include(d => d.CapitalStackItems)
            .Include(d => d.DealChecklistItems).ThenInclude(i => i.Template)
            .Include(d => d.DealChecklistItems).ThenInclude(i => i.Document)
            .Include(d => d.UploadedDocuments)
            .Include(d => d.DealInvestors)
            .FirstOrDefaultAsync(d => d.Id == DealId);

        if (_deal is not null)
        {
            _property = _deal.Property ?? new Property(_deal.Address, _deal.UnitCount > 0 ? _deal.UnitCount : 1);
            _calc = _deal.CalculationResult;
            _capitalStack = _deal.CapitalStackItems.OrderBy(c => c.SortOrder).ToList();

            // Auto-generate checklist items on first visit
            if (!_deal.DealChecklistItems.Any())
            {
                await GenerateChecklistItems();
            }

            _checklistItems = _deal.DealChecklistItems
                .GroupBy(i => i.ChecklistTemplateId)
                .Select(g => g.First())
                .OrderBy(i => i.Template.SectionOrder)
                .ThenBy(i => i.Template.SortOrder)
                .ToList();

            _documents = _deal.UploadedDocuments.OrderByDescending(d => d.UploadedAt).ToList();
            _investors = _deal.DealInvestors.OrderBy(i => i.Name).ToList();
        }

        // Handle tab query parameter
        if (!string.IsNullOrEmpty(Tab))
        {
            _activePanelIndex = Tab.ToLowerInvariant() switch
            {
                "general" => 0,
                "underwriting" => 1,
                "investors" => 2,
                "checklist" => 3,
                "documents" => 4,
                "chat" => 5,
                _ => 0
            };
        }

        _loading = false;
    }

    private async Task RefreshDealData()
    {
        if (_deal is null) return;

        // Reload deal with all related data
        await Db.Entry(_deal).ReloadAsync();
        await Db.Entry(_deal).Collection(d => d.CapitalStackItems).LoadAsync();
        await Db.Entry(_deal).Reference(d => d.CalculationResult).LoadAsync();
        await Db.Entry(_deal).Reference(d => d.Property).LoadAsync();
        await Db.Entry(_deal).Collection(d => d.DealChecklistItems).LoadAsync();
        foreach (var item in _deal.DealChecklistItems)
            await Db.Entry(item).Reference(i => i.Template).LoadAsync();
        await Db.Entry(_deal).Collection(d => d.UploadedDocuments).LoadAsync();
        await Db.Entry(_deal).Collection(d => d.DealInvestors).LoadAsync();

        _property = _deal.Property ?? new Property(_deal.Address, _deal.UnitCount > 0 ? _deal.UnitCount : 1);
        _calc = _deal.CalculationResult;
        _capitalStack = _deal.CapitalStackItems.OrderBy(c => c.SortOrder).ToList();
        _checklistItems = _deal.DealChecklistItems
            .OrderBy(i => i.Template.SectionOrder)
            .ThenBy(i => i.Template.SortOrder)
            .ToList();
        _documents = _deal.UploadedDocuments.OrderByDescending(d => d.UploadedAt).ToList();
        _investors = _deal.DealInvestors.OrderBy(i => i.Name).ToList();

        await InvokeAsync(StateHasChanged);
    }

    private async Task GenerateChecklistItems()
    {
        if (_deal is null) return;

        var templates = await Db.ChecklistTemplates
            .Where(t => t.ExecutionType == ExecutionType.All || t.ExecutionType == _deal.ExecutionType)
            .Where(t => t.TransactionType == "All" || t.TransactionType == _deal.TransactionType)
            .OrderBy(t => t.SectionOrder).ThenBy(t => t.SortOrder)
            .ToListAsync();

        var existingTemplateIds = _deal.DealChecklistItems
            .Select(ci => ci.ChecklistTemplateId)
            .ToHashSet();

        foreach (var template in templates)
        {
            if (existingTemplateIds.Contains(template.Id)) continue;

            var item = new DealChecklistItem(_deal.Id, template.Id);
            item.Template = template;
            Db.DealChecklistItems.Add(item);
            _deal.DealChecklistItems.Add(item);
        }

        await Db.SaveChangesAsync();
    }

    private void OnTabChanged(int index)
    {
        _activePanelIndex = index;
    }

    private async Task SaveGeneralAsync()
    {
        if (_deal is null) return;

        _saving = true;
        try
        {
            if (_deal.Property is null && _property is not null)
            {
                _property.DealId = _deal.Id;
                Db.Properties.Add(_property);
                _deal.Property = _property;
            }

            await Db.SaveChangesAsync();
            Snackbar.Add("Changes saved", Severity.Success);
        }
        catch (Exception)
        {
            Snackbar.Add("Failed to save changes", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task AddCapitalStackItem()
    {
        if (_deal is null || _newCapAmount <= 0) return;

        var item = new CapitalStackItem(_deal.Id, _newCapSource, _newCapAmount)
        {
            Rate = _newCapRate.HasValue ? _newCapRate.Value / 100m : null,
            TermYears = _newCapTerm,
            SortOrder = _capitalStack.Count
        };

        Db.CapitalStackItems.Add(item);
        await Db.SaveChangesAsync();
        _capitalStack.Add(item);

        // Reset form
        _newCapAmount = 0;
        _newCapRate = null;
        _newCapTerm = null;
        Snackbar.Add("Capital stack item added", Severity.Success);
    }

    private async Task RemoveCapitalStackItem(CapitalStackItem item)
    {
        Db.CapitalStackItems.Remove(item);
        await Db.SaveChangesAsync();
        _capitalStack.Remove(item);
        Snackbar.Add("Capital stack item removed", Severity.Success);
    }

    private void OpenAddInvestorDialog()
    {
        _editingInvestorId = null;
        ResetInvestorForm();
        _showInvestorForm = true;
    }

    private void OpenEditInvestorDialog(DealInvestor investor)
    {
        _editingInvestorId = investor.Id;
        _invName = investor.Name;
        _invCompany = investor.Company;
        _invRole = investor.Role;
        _invEmail = investor.Email;
        _invPhone = investor.Phone;
        _invAddress = investor.Address;
        _invCity = investor.City;
        _invState = investor.State;
        _invZip = investor.Zip;
        _invNetWorth = investor.NetWorth;
        _invLiquidity = investor.Liquidity;
        _invNotes = investor.Notes;
        _showInvestorForm = true;
    }

    private void CancelInvestorForm()
    {
        _showInvestorForm = false;
        ResetInvestorForm();
    }

    private void ResetInvestorForm()
    {
        _invName = "";
        _invCompany = null;
        _invRole = null;
        _invEmail = null;
        _invPhone = null;
        _invAddress = null;
        _invCity = null;
        _invState = null;
        _invZip = null;
        _invNetWorth = null;
        _invLiquidity = null;
        _invNotes = null;
    }

    private async Task SaveInvestor()
    {
        if (_deal is null || string.IsNullOrWhiteSpace(_invName)) return;

        if (_editingInvestorId.HasValue)
        {
            var investor = _investors.FirstOrDefault(i => i.Id == _editingInvestorId.Value);
            if (investor is not null)
            {
                investor.Name = _invName;
                investor.Company = _invCompany;
                investor.Role = _invRole;
                investor.Email = _invEmail;
                investor.Phone = _invPhone;
                investor.Address = _invAddress;
                investor.City = _invCity;
                investor.State = _invState;
                investor.Zip = _invZip;
                investor.NetWorth = _invNetWorth;
                investor.Liquidity = _invLiquidity;
                investor.Notes = _invNotes;
                await Db.SaveChangesAsync();
                Snackbar.Add("Investor updated", Severity.Success);
            }
        }
        else
        {
            var investor = new DealInvestor(_deal.Id, _invName)
            {
                Company = _invCompany,
                Role = _invRole,
                Email = _invEmail,
                Phone = _invPhone,
                Address = _invAddress,
                City = _invCity,
                State = _invState,
                Zip = _invZip,
                NetWorth = _invNetWorth,
                Liquidity = _invLiquidity,
                Notes = _invNotes
            };
            Db.DealInvestors.Add(investor);
            await Db.SaveChangesAsync();
            _investors.Add(investor);
            _investors = _investors.OrderBy(i => i.Name).ToList();
            Snackbar.Add("Investor added", Severity.Success);
        }

        _showInvestorForm = false;
        ResetInvestorForm();
    }

    private async Task DeleteInvestor(DealInvestor investor)
    {
        Db.DealInvestors.Remove(investor);
        await Db.SaveChangesAsync();
        _investors.Remove(investor);
        Snackbar.Add("Investor removed", Severity.Success);
    }

    private async Task UpdateChecklistStatus(DealChecklistItem item, ChecklistStatus newStatus)
    {
        item.UpdateStatus(newStatus);
        await Db.SaveChangesAsync();
    }

    private static string FormatChecklistStatus(ChecklistStatus status) => status switch
    {
        ChecklistStatus.Outstanding => "Outstanding",
        ChecklistStatus.UnderReview => "Under Review",
        ChecklistStatus.NeedAdditionalInfo => "Need Info",
        ChecklistStatus.WaiverRequested => "Waiver Req.",
        ChecklistStatus.WaiverApproved => "Waiver OK",
        ChecklistStatus.Satisfied => "Satisfied",
        ChecklistStatus.NotApplicable => "N/A",
        _ => status.ToString()
    };

    private static Color GetChecklistStatusColor(ChecklistStatus status) => status switch
    {
        ChecklistStatus.Outstanding => Color.Default,
        ChecklistStatus.UnderReview => Color.Warning,
        ChecklistStatus.NeedAdditionalInfo => Color.Info,
        ChecklistStatus.WaiverRequested => Color.Secondary,
        ChecklistStatus.WaiverApproved => Color.Tertiary,
        ChecklistStatus.Satisfied => Color.Success,
        ChecklistStatus.NotApplicable => Color.Dark,
        _ => Color.Default
    };

    private static string FormatCurrency(decimal? value)
        => value.HasValue ? $"${value.Value:N0}" : "\u2014";

    private static string FormatCurrencyNeg(decimal? value)
        => value.HasValue ? $"(${value.Value:N0})" : "\u2014";

    private static string FormatPercent(decimal? value)
        => value.HasValue ? $"{value.Value * 100:F1}%" : "\u2014";

    private static string FormatMultiple(decimal? value)
        => value.HasValue ? $"{value.Value:F2}x" : "\u2014";

    private static string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }

    private static string GetDocIcon(string fileName)
    {
        var ext = Path.GetExtension(fileName).ToLowerInvariant();
        return ext switch
        {
            ".pdf" => Icons.Material.Filled.PictureAsPdf,
            ".xlsx" or ".csv" => Icons.Material.Filled.TableChart,
            ".docx" => Icons.Material.Filled.Article,
            _ => Icons.Material.Filled.InsertDriveFile
        };
    }

    private static Color GetStatusColor(string status) => status switch
    {
        "Draft" => Color.Default,
        "InProgress" => Color.Warning,
        "Complete" => Color.Success,
        "Archived" => Color.Dark,
        _ => Color.Default
    };
}
