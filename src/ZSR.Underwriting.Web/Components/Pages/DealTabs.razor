@page "/deals/{DealId:guid}"
@using ZSR.Underwriting.Domain.Entities
@using ZSR.Underwriting.Domain.Enums
@using ZSR.Underwriting.Infrastructure.Data
@using ZSR.Underwriting.Application.Constants
@using ZSR.Underwriting.Application.DTOs
@using ZSR.Underwriting.Application.Interfaces
@using ZSR.Underwriting.Application.Calculations
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@inject AppDbContext Db
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDocumentUploadService UploadService
@inject IDocumentMatchingService MatchingService
@inject IActivityTracker ActivityTracker
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@inject ISensitivityCalculator SensitivityCalc
@inject IMarketDataService MarketDataService
@inject IDealService DealService
@inject IDialogService DialogService
@inject IContractService ContractService
@inject IRentRollService RentRollService
@inject IPortfolioService PortfolioService
@inject IActualsService ActualsService
@inject ICapExService CapExService
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>@(_deal?.PropertyName ?? "Deal") - Underwriting Analyst</PageTitle>

@if (_loading)
{
    <MudStack AlignItems="AlignItems.Center" Class="pa-8">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    </MudStack>
}
else if (_deal is null)
{
    <MudStack AlignItems="AlignItems.Center" Spacing="4" Class="pa-8">
        <MudIcon Icon="@Icons.Material.Outlined.SearchOff" Size="Size.Large" Style="color: #D1D5DB;" />
        <MudText Typo="Typo.h6" Style="color: #6B7280;">Deal not found</MudText>
        <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.ArrowBack"
                   OnClick="@(() => Navigation.NavigateTo("/deals"))"
                   Style="text-transform: none;">
            Back to Pipeline
        </MudButton>
    </MudStack>
}
else
{
    <div class="deal-tabs-header">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                       OnClick="@(() => Navigation.NavigateTo("/deals"))"
                       Style="color: #6B7280;" />
        <div style="flex: 1; min-width: 0;">
            <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1A2332; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                @_deal.PropertyName
            </MudText>
            <MudText Typo="Typo.body2" Style="color: #6B7280;">
                @_deal.Address
            </MudText>
        </div>
        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(_deal.Status.ToString())">
            @GetStatusDisplayName(_deal.Status)
        </MudChip>
        @if (GetNextTransition(_deal.Status) is var (label, target) && label is not null)
        {
            <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.ArrowForward"
                       OnClick="@(() => TransitionStatus(target))"
                       Style="text-transform: none; font-weight: 500; border-radius: 12px;">
                @label
            </MudButton>
        }
        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Description"
                   OnClick="@(() => Navigation.NavigateTo($"/deals/{DealId}/report"))"
                   Class="generate-report-btn"
                   Style="text-transform: none; font-weight: 500; border-radius: 12px;">
            Generate Report
        </MudButton>
        <MudTooltip Text="@(_chatOpen ? "Close Chat" : "Open Chat")">
            <MudIconButton Icon="@Icons.Material.Filled.Chat"
                           Color="@(_chatOpen ? Color.Primary : Color.Default)"
                           OnClick="ToggleChat"
                           Class="chat-toggle-btn" />
        </MudTooltip>
    </div>

    <div class="deal-layout @(_chatOpen ? "chat-open" : "")">

    <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" Class="deal-tabs-container"
             PanelClass="deal-tab-panel" KeepPanelsAlive="true"
             ActivePanelIndex="_activePanelIndex" ActivePanelIndexChanged="OnTabChanged">
        <MudTabPanel Text="General" Icon="@Icons.Material.Filled.Info">
            <div class="deal-tab-content">
                <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight: 600; color: #1A2332;">Property Information</MudText>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_deal.PropertyName" Label="Property Name" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_deal.Address" Label="Address" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudNumericField @bind-Value="_deal.UnitCount" Label="Unit Count" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudNumericField @bind-Value="_property.YearBuilt" Label="Year Built" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudTextField @bind-Value="_property.BuildingType" Label="Building Type" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudNumericField @bind-Value="_property.SquareFootage" Label="Square Footage" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudNumericField @bind-Value="_property.Acreage" Label="Acreage" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudNumericField @bind-Value="_deal.PurchasePrice" Label="Purchase Price" Variant="Variant.Outlined"
                                         Format="N0" Adornment="Adornment.Start" AdornmentText="$" />
                    </MudItem>
                </MudGrid>

                <MudText Typo="Typo.h6" Class="mt-6 mb-4" Style="font-weight: 600; color: #1A2332;">Deal Classification</MudText>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudSelect @bind-Value="_deal.ExecutionType" Label="Execution Type" Variant="Variant.Outlined">
                            @foreach (var et in Enum.GetValues<ExecutionType>())
                            {
                                <MudSelectItem Value="@et">@et</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="_deal.TransactionType" Label="Transaction Type" Variant="Variant.Outlined" />
                    </MudItem>
                </MudGrid>

                <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-6">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Save"
                               OnClick="SaveGeneralAsync"
                               Disabled="_saving"
                               Style="text-transform: none; font-weight: 500;">
                        @(_saving ? "Saving..." : "Save Changes")
                    </MudButton>
                </MudStack>
            </div>
        </MudTabPanel>

        <MudTabPanel Text="Underwriting" Icon="@Icons.Material.Filled.Analytics">
            <div class="deal-tab-content">
                @if (_calc is null)
                {
                    <MudAlert Severity="Severity.Info" Class="mb-4">
                        Underwriting metrics will appear here as the AI analyzes your deal.
                    </MudAlert>
                }
                else
                {
                    @* NOI Breakdown *@
                    <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #1A2332;">NOI Breakdown</MudText>
                    <MudSimpleTable Dense="true" Hover="true" Elevation="0" Style="border: 1px solid #E5E7EB; border-radius: 8px; margin-bottom: 1.5rem;">
                        <tbody>
                            <tr><td>Gross Potential Rent</td><td style="text-align: right;">@FormatCurrency(_calc.GrossPotentialRent)</td></tr>
                            <tr><td>Vacancy Loss</td><td style="text-align: right; color: #DC2626;">@FormatCurrencyNeg(_calc.VacancyLoss)</td></tr>
                            <tr><td>Effective Gross Income</td><td style="text-align: right;">@FormatCurrency(_calc.EffectiveGrossIncome)</td></tr>
                            <tr><td>Other Income</td><td style="text-align: right;">@FormatCurrency(_calc.OtherIncome)</td></tr>
                            <tr><td>Operating Expenses</td><td style="text-align: right; color: #DC2626;">@FormatCurrencyNeg(_calc.OperatingExpenses)</td></tr>
                            <tr style="font-weight: 700; background: #F9FAFB;"><td>Net Operating Income</td><td style="text-align: right;">@FormatCurrency(_calc.NetOperatingIncome)</td></tr>
                        </tbody>
                    </MudSimpleTable>

                    @* Key Metrics *@
                    <MudGrid Class="mb-6">
                        <MudItem xs="12" md="4">
                            <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                                <MudText Typo="Typo.caption" Style="color: #6B7280;">Going-In Cap Rate</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1A2332;">@FormatPercent(_calc.GoingInCapRate)</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                                <MudText Typo="Typo.caption" Style="color: #6B7280;">Exit Cap Rate</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1A2332;">@FormatPercent(_calc.ExitCapRate)</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                                <MudText Typo="Typo.caption" Style="color: #6B7280;">Price Per Unit</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1A2332;">@FormatCurrency(_calc.PricePerUnit)</MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>

                    @* Return Metrics *@
                    <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #1A2332;">Return Metrics</MudText>
                    <MudGrid Class="mb-6">
                        <MudItem xs="12" md="4">
                            <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                                <MudText Typo="Typo.caption" Style="color: #6B7280;">Cash-on-Cash Return</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1A2332;">@FormatPercent(_calc.CashOnCashReturn)</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                                <MudText Typo="Typo.caption" Style="color: #6B7280;">IRR</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1A2332;">@FormatPercent(_calc.InternalRateOfReturn)</MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                                <MudText Typo="Typo.caption" Style="color: #6B7280;">Equity Multiple</MudText>
                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1A2332;">@FormatMultiple(_calc.EquityMultiple)</MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>

                    @* Debt Metrics *@
                    <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #1A2332;">Debt Metrics</MudText>
                    <MudSimpleTable Dense="true" Hover="true" Elevation="0" Style="border: 1px solid #E5E7EB; border-radius: 8px; margin-bottom: 1.5rem;">
                        <tbody>
                            <tr><td>Loan Amount</td><td style="text-align: right;">@FormatCurrency(_calc.LoanAmount)</td></tr>
                            <tr><td>Annual Debt Service</td><td style="text-align: right;">@FormatCurrency(_calc.AnnualDebtService)</td></tr>
                            <tr><td>DSCR</td><td style="text-align: right;">@FormatMultiple(_calc.DebtServiceCoverageRatio)</td></tr>
                        </tbody>
                    </MudSimpleTable>

                    @* Sensitivity Analysis *@
                    @if (_sensitivityScenarios?.Count > 0)
                    {
                        <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #1A2332;">Sensitivity Analysis</MudText>
                        <MudSimpleTable Dense="true" Hover="true" Elevation="0" Style="border: 1px solid #E5E7EB; border-radius: 8px; margin-bottom: 1.5rem;">
                            <thead>
                                <tr style="background: #F9FAFB;">
                                    <th>Scenario</th>
                                    <th style="text-align: right;">NOI</th>
                                    <th style="text-align: right;">NOI Delta</th>
                                    <th style="text-align: right;">Exit Value</th>
                                    <th style="text-align: right;">Exit Delta</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var s in _sensitivityScenarios)
                                {
                                    <tr>
                                        <td style="font-weight: @(s.Name == "Base Case" ? "700" : "400");">@s.Name</td>
                                        <td style="text-align: right;">@FormatCurrency(s.Noi)</td>
                                        <td style="text-align: right; color: @DeltaColor(s.NoiDelta);">@FormatDelta(s.NoiDelta)</td>
                                        <td style="text-align: right;">@FormatCurrency(s.ExitValue)</td>
                                        <td style="text-align: right; color: @DeltaColor(s.ExitValueDelta);">@FormatDelta(s.ExitValueDelta)</td>
                                    </tr>
                                }
                            </tbody>
                        </MudSimpleTable>
                    }
                }

                @* Capital Stack *@
                <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #1A2332;">Capital Stack</MudText>
                <MudTable Items="_capitalStack" Dense="true" Hover="true" Elevation="0"
                          Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                    <HeaderContent>
                        <MudTh>Source</MudTh>
                        <MudTh Style="text-align: right;">Amount</MudTh>
                        <MudTh Style="text-align: right;">Rate</MudTh>
                        <MudTh Style="text-align: right;">Term (Yrs)</MudTh>
                        <MudTh Style="text-align: center;">Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>@context.Source</MudTd>
                        <MudTd Style="text-align: right;">@FormatCurrency(context.Amount)</MudTd>
                        <MudTd Style="text-align: right;">@FormatPercent(context.Rate)</MudTd>
                        <MudTd Style="text-align: right;">@(context.TermYears?.ToString() ?? "\u2014")</MudTd>
                        <MudTd Style="text-align: center;">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                           OnClick="@(() => RemoveCapitalStackItem(context))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>

                @* Summary totals *@
                <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-3 px-4">
                    <MudText Typo="Typo.body1" Style="font-weight: 600;">Total Sources</MudText>
                    <MudText Typo="Typo.body1" Style="font-weight: 700;">@FormatCurrency(_capitalStack.Sum(c => c.Amount))</MudText>
                </MudStack>
                @if (_deal!.PurchasePrice > 0)
                {
                    <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-1 px-4">
                        <MudText Typo="Typo.body1" Style="font-weight: 600;">Equity Required</MudText>
                        <MudText Typo="Typo.body1" Style="font-weight: 700; color: #F97316;">
                            @FormatCurrency(_deal.PurchasePrice - _capitalStack.Where(c => c.Source == CapitalSource.SeniorDebt || c.Source == CapitalSource.Mezzanine).Sum(c => c.Amount))
                        </MudText>
                    </MudStack>
                }

                @* Add new capital stack item *@
                <MudStack Row="true" AlignItems="AlignItems.Center" Class="mt-4" Spacing="2">
                    <MudSelect @bind-Value="_newCapSource" Label="Source" Variant="Variant.Outlined" Style="max-width: 200px;">
                        @foreach (var cs in Enum.GetValues<CapitalSource>())
                        {
                            <MudSelectItem Value="@cs">@cs</MudSelectItem>
                        }
                    </MudSelect>
                    <MudNumericField @bind-Value="_newCapAmount" Label="Amount" Variant="Variant.Outlined"
                                     Adornment="Adornment.Start" AdornmentText="$" Format="N0" Style="max-width: 200px;" />
                    <MudNumericField @bind-Value="_newCapRate" Label="Rate %" Variant="Variant.Outlined" Style="max-width: 120px;" />
                    <MudNumericField @bind-Value="_newCapTerm" Label="Term" Variant="Variant.Outlined" Style="max-width: 100px;" />
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Add"
                               OnClick="AddCapitalStackItem"
                               Style="text-transform: none; font-weight: 500;">
                        Add
                    </MudButton>
                </MudStack>
            </div>
        </MudTabPanel>

        <MudTabPanel Text="Investors" Icon="@Icons.Material.Filled.People">
            <div class="deal-tab-content">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Typo="Typo.h6" Style="font-weight: 600; color: #1A2332;">
                        Investors (@_investors.Count)
                    </MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.PersonAdd"
                               OnClick="OpenAddInvestorDialog"
                               Style="text-transform: none; font-weight: 500;">
                        Add Investor
                    </MudButton>
                </MudStack>

                @if (!_investors.Any())
                {
                    <MudPaper Elevation="0" Class="pa-8" Style="text-align: center; border: 1px solid #E5E7EB; border-radius: 8px;">
                        <MudIcon Icon="@Icons.Material.Outlined.PersonOff" Size="Size.Large" Style="color: #D1D5DB;" />
                        <MudText Typo="Typo.body1" Style="color: #6B7280; margin-top: 0.5rem;">
                            No investors added yet. Click "Add Investor" to get started.
                        </MudText>
                    </MudPaper>
                }
                else
                {
                    <MudTable Items="_investors" Dense="true" Hover="true" Elevation="0"
                              Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                        <HeaderContent>
                            <MudTh>Name</MudTh>
                            <MudTh>Company</MudTh>
                            <MudTh>Role</MudTh>
                            <MudTh>Email</MudTh>
                            <MudTh>Phone</MudTh>
                            <MudTh Style="text-align: right;">Net Worth</MudTh>
                            <MudTh Style="text-align: right;">Liquidity</MudTh>
                            <MudTh Style="text-align: center;">Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Name</MudTd>
                            <MudTd>@(context.Company ?? "\u2014")</MudTd>
                            <MudTd>@(context.Role ?? "\u2014")</MudTd>
                            <MudTd>@(context.Email ?? "\u2014")</MudTd>
                            <MudTd>@(context.Phone ?? "\u2014")</MudTd>
                            <MudTd Style="text-align: right;">@FormatCurrency(context.NetWorth)</MudTd>
                            <MudTd Style="text-align: right;">@FormatCurrency(context.Liquidity)</MudTd>
                            <MudTd Style="text-align: center;">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary"
                                               OnClick="@(() => OpenEditInvestorDialog(context))" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                               OnClick="@(() => DeleteInvestor(context))" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }

                @* Add/Edit Investor Inline Form *@
                @if (_showInvestorForm)
                {
                    <MudPaper Elevation="2" Class="pa-4 mt-4" Style="border-radius: 8px;">
                        <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600; color: #1A2332;">
                            @(_editingInvestorId.HasValue ? "Edit Investor" : "New Investor")
                        </MudText>
                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="_invName" Label="Name" Variant="Variant.Outlined" Required="true" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="_invCompany" Label="Company" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudTextField @bind-Value="_invRole" Label="Role" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudTextField @bind-Value="_invEmail" Label="Email" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudTextField @bind-Value="_invPhone" Label="Phone" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudTextField @bind-Value="_invAddress" Label="Address" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="3">
                                <MudTextField @bind-Value="_invCity" Label="City" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="2">
                                <MudTextField @bind-Value="_invState" Label="State" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="3">
                                <MudTextField @bind-Value="_invZip" Label="Zip" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_invNetWorth" Label="Net Worth" Variant="Variant.Outlined"
                                                 Adornment="Adornment.Start" AdornmentText="$" Format="N0" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudNumericField @bind-Value="_invLiquidity" Label="Liquidity" Variant="Variant.Outlined"
                                                 Adornment="Adornment.Start" AdornmentText="$" Format="N0" />
                            </MudItem>
                            <MudItem xs="12">
                                <MudTextField @bind-Value="_invNotes" Label="Notes" Variant="Variant.Outlined" Lines="2" />
                            </MudItem>
                        </MudGrid>
                        <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-3" Spacing="2">
                            <MudButton Variant="Variant.Text" OnClick="CancelInvestorForm" Style="text-transform: none;">Cancel</MudButton>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Save"
                                       OnClick="SaveInvestor"
                                       Style="text-transform: none; font-weight: 500;">
                                @(_editingInvestorId.HasValue ? "Update" : "Save")
                            </MudButton>
                        </MudStack>
                    </MudPaper>
                }
            </div>
        </MudTabPanel>

        <MudTabPanel Text="Checklist" Icon="@Icons.Material.Filled.Checklist">
            <div class="deal-tab-content">
                @* Progress summary *@
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Typo="Typo.h6" Style="font-weight: 600; color: #1A2332;">Due Diligence Checklist</MudText>
                    <MudText Typo="Typo.body2" Style="color: #6B7280; font-weight: 500;">
                        @($"{_checklistItems.Count(i => i.Status == ChecklistStatus.Satisfied)} / {_checklistItems.Count} satisfied")
                    </MudText>
                </MudStack>

                @foreach (var grp in _checklistItems
                    .GroupBy(i => i.Template.Section)
                    .OrderBy(g => g.First().Template.SectionOrder))
                {
                    <MudText Typo="Typo.subtitle1" Class="mt-4 mb-2" Style="font-weight: 600; color: #374151;">
                        @grp.Key
                    </MudText>

                    @foreach (var item in grp.OrderBy(i => i.Template.SortOrder))
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2 pa-2"
                                  Style="border: 1px solid #E5E7EB; border-radius: 8px; background: #FFFFFF;">
                            <MudChip T="string" Size="Size.Small" Color="@GetChecklistStatusColor(item.Status)"
                                     Style="min-width: 120px; text-align: center;">
                                @FormatChecklistStatus(item.Status)
                            </MudChip>
                            <MudText Style="flex: 1; color: #1A2332;">@item.Template.ItemName</MudText>
                            @if (item.DocumentId != null)
                            {
                                <MudTooltip Text="@($"Download: {item.Document?.FileName ?? "document"}")">
                                    <MudIconButton Icon="@Icons.Material.Filled.Download"
                                                   Size="Size.Small" Color="Color.Primary"
                                                   Href="@($"/api/documents/{item.DocumentId}/download")"
                                                   Target="_blank" />
                                </MudTooltip>
                                <MudTooltip Text="Reassign document to a different checklist item">
                                    <MudMenu Icon="@Icons.Material.Filled.SwapHoriz" Size="Size.Small"
                                             Color="Color.Default" Dense="true">
                                        @foreach (var target in _checklistItems.Where(ci => ci.Id != item.Id && ci.DocumentId == null))
                                        {
                                            <MudMenuItem OnClick="@(() => ReassignDocumentAsync(item, target))">
                                                @target.Template.ItemName
                                            </MudMenuItem>
                                        }
                                        <MudMenuItem OnClick="@(() => UnlinkDocumentAsync(item))">
                                            <MudText Typo="Typo.body2" Color="Color.Error">Unlink document</MudText>
                                        </MudMenuItem>
                                    </MudMenu>
                                </MudTooltip>
                            }
                            @if (_uploadingItemId == item.Id)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Primary" />
                            }
                            else
                            {
                                <MudTooltip Text="Upload document">
                                    <label style="cursor: pointer; display: inline-flex;">
                                        <InputFile OnChange="@(e => OnChecklistFileSelected(item, e.File))"
                                                   accept="@string.Join(",", FileUploadConstants.AllowedExtensions)"
                                                   style="display: none;" />
                                        <MudIcon Icon="@Icons.Material.Filled.UploadFile"
                                                 Size="Size.Small" Color="Color.Default" />
                                    </label>
                                </MudTooltip>
                            }
                            <MudSelect T="ChecklistStatus" Value="item.Status"
                                       ValueChanged="@(val => UpdateChecklistStatus(item, val))"
                                       Variant="Variant.Outlined" Dense="true"
                                       Style="max-width: 180px;">
                                @foreach (var s in Enum.GetValues<ChecklistStatus>())
                                {
                                    <MudSelectItem Value="@s">@FormatChecklistStatus(s)</MudSelectItem>
                                }
                            </MudSelect>
                        </MudStack>
                    }
                }

                @if (!_checklistItems.Any())
                {
                    <MudAlert Severity="Severity.Info">No checklist items for this deal's execution type.</MudAlert>
                }
            </div>
        </MudTabPanel>

        <MudTabPanel Text="Documents" Icon="@Icons.Material.Filled.FolderOpen">
            <div class="deal-tab-content">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Typo="Typo.h6" Style="font-weight: 600; color: #1A2332;">
                        Documents (@_documents.Count)
                    </MudText>
                </MudStack>

                <MudPaper Elevation="0" Class="pa-3 mb-4" Style="border: 1px solid #E5E7EB; border-radius: 8px; background: #F9FAFB;">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Style="color: #6B7280;" />
                        <MudText Typo="Typo.body2" Style="color: #6B7280;">
                            Email documents to:
                        </MudText>
                        <MudText Typo="Typo.body2" Style="font-weight: 600; color: #1A2332; font-family: monospace;">
                            @DealIngestEmail
                        </MudText>
                        <MudTooltip Text="Copy email address">
                            <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                           Size="Size.Small" Color="Color.Default"
                                           OnClick="CopyDealEmailAsync" />
                        </MudTooltip>
                    </MudStack>
                </MudPaper>

                @if (!_documents.Any())
                {
                    <MudPaper Elevation="0" Class="pa-8" Style="text-align: center; border: 1px solid #E5E7EB; border-radius: 8px;">
                        <MudIcon Icon="@Icons.Material.Outlined.FolderOff" Size="Size.Large" Style="color: #D1D5DB;" />
                        <MudText Typo="Typo.body1" Style="color: #6B7280; margin-top: 0.5rem;">
                            No documents uploaded yet. Upload files via the Chat tab.
                        </MudText>
                    </MudPaper>
                }
                else
                {
                    <MudTable Items="_documents" Dense="true" Hover="true" Elevation="0"
                              Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                        <HeaderContent>
                            <MudTh>File Name</MudTh>
                            <MudTh>Type</MudTh>
                            <MudTh>Size</MudTh>
                            <MudTh>Uploaded</MudTh>
                            <MudTh Style="text-align: center;">Download</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@GetDocIcon(context.FileName)" Size="Size.Small" Style="color: #F97316;" />
                                    <span>@context.FileName</span>
                                </MudStack>
                            </MudTd>
                            <MudTd>@context.DocumentType</MudTd>
                            <MudTd>@FormatFileSize(context.FileSize)</MudTd>
                            <MudTd>@context.UploadedAt.ToString("MMM dd, yyyy h:mm tt")</MudTd>
                            <MudTd Style="text-align: center;">
                                <MudIconButton Icon="@Icons.Material.Filled.Download"
                                               Size="Size.Small" Color="Color.Primary"
                                               Href="@($"/api/documents/{context.Id}/download")"
                                               Target="_blank" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }

                @* Email ingestion log *@
                @if (_ingestionLogs.Any())
                {
                    <MudText Typo="Typo.h6" Class="mt-6 mb-3" Style="font-weight: 600; color: #1A2332;">
                        Recent Email Activity
                    </MudText>
                    <MudTable Items="_ingestionLogs" Dense="true" Hover="true" Elevation="0"
                              Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                        <HeaderContent>
                            <MudTh>Status</MudTh>
                            <MudTh>Sender</MudTh>
                            <MudTh>Reason</MudTh>
                            <MudTh>Attachments</MudTh>
                            <MudTh>When</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>
                                <MudChip T="string" Size="Size.Small"
                                         Color="@(context.Status == EmailIngestionStatus.Accepted ? Color.Success : Color.Error)">
                                    @context.Status
                                </MudChip>
                            </MudTd>
                            <MudTd>@context.SenderEmail</MudTd>
                            <MudTd>@context.Reason</MudTd>
                            <MudTd>@context.AttachmentCount</MudTd>
                            <MudTd>@context.CreatedAt.ToString("MMM dd, h:mm tt")</MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </div>
        </MudTabPanel>

        @* === Phase-gated tabs === *@

        @if (_deal.Phase >= DealPhase.Contract)
        {
            <MudTabPanel Text="Contract" Icon="@Icons.Material.Filled.Gavel">
                <div class="deal-tab-content">
                    @if (_contractTimeline is null)
                    {
                        <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                    }
                    else
                    {
                        <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight: 600; color: #1A2332;">Contract Timeline</MudText>
                        @if (GetNextContractDeadline() is var (dlName, dlDate, dlDays))
                        {
                            <MudAlert Severity="@(dlDays <= 7 ? Severity.Warning : Severity.Info)" Class="mb-4">
                                Next deadline: <strong>@dlName</strong> in @dlDays days (@dlDate.ToString("MMM d, yyyy"))
                            </MudAlert>
                        }
                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudDatePicker @bind-Date="_contractLoiDate" Label="LOI Date" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudDatePicker @bind-Date="_contractPsaDate" Label="PSA Executed" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudDatePicker @bind-Date="_contractInspectionDate" Label="Inspection Deadline" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudDatePicker @bind-Date="_contractFinancingDate" Label="Financing Contingency" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudDatePicker @bind-Date="_contractAppraisalDate" Label="Appraisal Deadline" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudDatePicker @bind-Date="_contractTitleDate" Label="Title Deadline" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudDatePicker @bind-Date="_contractClosingDate" Label="Target Closing" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudDatePicker @bind-Date="_contractActualClosingDate" Label="Actual Closing" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudNumericField @bind-Value="_contractEarnestMoney" Label="Earnest Money" Variant="Variant.Outlined"
                                                 Format="N0" Adornment="Adornment.Start" AdornmentText="$" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudTextField @bind-Value="_contractLenderName" Label="Lender" Variant="Variant.Outlined" />
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudTextField @bind-Value="_contractTitleCompany" Label="Title Company" Variant="Variant.Outlined" />
                            </MudItem>
                        </MudGrid>
                        <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-4">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Save"
                                       OnClick="SaveContractTimelineAsync"
                                       Style="text-transform: none; font-weight: 500;">
                                Save Timeline
                            </MudButton>
                        </MudStack>

                        <MudDivider Class="my-6" />

                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                            <MudText Typo="Typo.h6" Style="font-weight: 600; color: #1A2332;">Closing Costs</MudText>
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.Add"
                                       OnClick="@(() => _showClosingCostForm = true)"
                                       Style="text-transform: none;">
                                Add Cost
                            </MudButton>
                        </MudStack>

                        @if (_showClosingCostForm)
                        {
                            <MudPaper Elevation="0" Class="pa-4 mb-4" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                                <MudGrid>
                                    <MudItem xs="12" md="3">
                                        <MudSelect @bind-Value="_newCostCategory" Label="Category" Variant="Variant.Outlined">
                                            @foreach (var cat in new[] { "Title", "Legal", "Lender", "Survey", "Insurance", "Escrow", "Other" })
                                            {
                                                <MudSelectItem Value="@cat">@cat</MudSelectItem>
                                            }
                                        </MudSelect>
                                    </MudItem>
                                    <MudItem xs="12" md="4">
                                        <MudTextField @bind-Value="_newCostDescription" Label="Description" Variant="Variant.Outlined" />
                                    </MudItem>
                                    <MudItem xs="12" md="3">
                                        <MudNumericField @bind-Value="_newCostEstimated" Label="Estimated" Variant="Variant.Outlined"
                                                         Format="N0" Adornment="Adornment.Start" AdornmentText="$" />
                                    </MudItem>
                                    <MudItem xs="12" md="2" Class="d-flex align-end">
                                        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                                   OnClick="AddClosingCostAsync"
                                                   Style="text-transform: none;">Add</MudButton>
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>
                        }

                        @if (_closingCosts.Count > 0)
                        {
                            <MudSimpleTable Dense="true" Hover="true" Elevation="0" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Description</th>
                                        <th style="text-align: right;">Estimated</th>
                                        <th style="text-align: right;">Actual</th>
                                        <th style="text-align: center;">Paid</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var cost in _closingCosts)
                                    {
                                        <tr>
                                            <td>@cost.Category</td>
                                            <td>@cost.Description</td>
                                            <td style="text-align: right;">@cost.EstimatedAmount.ToString("C0")</td>
                                            <td style="text-align: right;">@(cost.ActualAmount?.ToString("C0") ?? "â€”")</td>
                                            <td style="text-align: center;">
                                                <MudCheckBox T="bool" Value="@cost.IsPaid"
                                                             ValueChanged="@(v => ToggleClosingCostPaidAsync(cost, v))" />
                                            </td>
                                            <td>
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small"
                                                               OnClick="@(() => DeleteClosingCostAsync(cost.Id))" />
                                            </td>
                                        </tr>
                                    }
                                    <tr style="font-weight: 600; border-top: 2px solid #E5E7EB;">
                                        <td colspan="2">Total</td>
                                        <td style="text-align: right;">@_closingCosts.Sum(c => c.EstimatedAmount).ToString("C0")</td>
                                        <td style="text-align: right;">@_closingCosts.Where(c => c.ActualAmount.HasValue).Sum(c => c.ActualAmount!.Value).ToString("C0")</td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </MudSimpleTable>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Style="color: #9CA3AF;" Class="mt-2">No closing costs added yet.</MudText>
                        }
                    }
                </div>
            </MudTabPanel>
        }

        @if (_deal.Phase >= DealPhase.Ownership)
        {
            <MudTabPanel Text="Rent Roll" Icon="@Icons.Material.Filled.Apartment">
                <div class="deal-tab-content">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                        <MudText Typo="Typo.h6" Style="font-weight: 600; color: #1A2332;">Unit-Level Rent Roll</MudText>
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   OnClick="@(() => _showUnitForm = true)"
                                   Style="text-transform: none;">
                            Add Unit
                        </MudButton>
                    </MudStack>

                    @if (_rentRollSummary is not null && _rentRollUnits.Count > 0)
                    {
                        <MudGrid Class="mb-4">
                            <MudItem xs="6" md="2">
                                <MudPaper Elevation="0" Class="pa-3" Style="border: 1px solid #E5E7EB; border-radius: 8px; text-align: center;">
                                    <MudText Typo="Typo.caption" Style="color: #6B7280;">Total Units</MudText>
                                    <MudText Typo="Typo.h6" Style="font-weight: 700;">@_rentRollSummary.TotalUnits</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" md="2">
                                <MudPaper Elevation="0" Class="pa-3" Style="border: 1px solid #E5E7EB; border-radius: 8px; text-align: center;">
                                    <MudText Typo="Typo.caption" Style="color: #6B7280;">Occupancy</MudText>
                                    <MudText Typo="Typo.h6" Style="font-weight: 700;">@_rentRollSummary.OccupancyPercent.ToString("F1")%</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" md="2">
                                <MudPaper Elevation="0" Class="pa-3" Style="border: 1px solid #E5E7EB; border-radius: 8px; text-align: center;">
                                    <MudText Typo="Typo.caption" Style="color: #6B7280;">Avg Market Rent</MudText>
                                    <MudText Typo="Typo.h6" Style="font-weight: 700;">@_rentRollSummary.AverageMarketRent.ToString("C0")</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" md="3">
                                <MudPaper Elevation="0" Class="pa-3" Style="border: 1px solid #E5E7EB; border-radius: 8px; text-align: center;">
                                    <MudText Typo="Typo.caption" Style="color: #6B7280;">Gross Potential Rent</MudText>
                                    <MudText Typo="Typo.h6" Style="font-weight: 700;">@_rentRollSummary.TotalGrossPotentialRent.ToString("C0")</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" md="3">
                                <MudPaper Elevation="0" Class="pa-3" Style="border: 1px solid #E5E7EB; border-radius: 8px; text-align: center;">
                                    <MudText Typo="Typo.caption" Style="color: #6B7280;">Total Actual Rent</MudText>
                                    <MudText Typo="Typo.h6" Style="font-weight: 700;">@_rentRollSummary.TotalActualRent.ToString("C0")</MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>
                    }

                    @if (_showUnitForm)
                    {
                        <MudPaper Elevation="0" Class="pa-4 mb-4" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                            <MudGrid>
                                <MudItem xs="6" md="2">
                                    <MudTextField @bind-Value="_newUnitNumber" Label="Unit #" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="6" md="1">
                                    <MudNumericField @bind-Value="_newUnitBeds" Label="Beds" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="6" md="1">
                                    <MudNumericField @bind-Value="_newUnitBaths" Label="Baths" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="6" md="1">
                                    <MudNumericField @bind-Value="_newUnitSqFt" Label="SqFt" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="6" md="2">
                                    <MudNumericField @bind-Value="_newUnitMarketRent" Label="Market Rent" Variant="Variant.Outlined"
                                                     Adornment="Adornment.Start" AdornmentText="$" />
                                </MudItem>
                                <MudItem xs="6" md="2">
                                    <MudSelect @bind-Value="_newUnitStatus" Label="Status" Variant="Variant.Outlined">
                                        @foreach (var s in Enum.GetValues<UnitStatus>())
                                        {
                                            <MudSelectItem Value="@s">@s</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="6" md="2">
                                    <MudTextField @bind-Value="_newUnitTenant" Label="Tenant" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" Class="d-flex justify-end gap-2">
                                    <MudButton Variant="Variant.Text" OnClick="@(() => _showUnitForm = false)"
                                               Style="text-transform: none;">Cancel</MudButton>
                                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                               OnClick="AddRentRollUnitAsync"
                                               Style="text-transform: none;">Add Unit</MudButton>
                                </MudItem>
                            </MudGrid>
                        </MudPaper>
                    }

                    @if (_rentRollUnits.Count > 0)
                    {
                        <MudDataGrid Items="@_rentRollUnits" Dense="true" Hover="true" Elevation="0"
                                     Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                            <Columns>
                                <PropertyColumn Property="x => x.UnitNumber" Title="Unit" />
                                <PropertyColumn Property="x => x.Bedrooms" Title="Beds" />
                                <PropertyColumn Property="x => x.Bathrooms" Title="Baths" />
                                <PropertyColumn Property="x => x.SquareFeet" Title="SqFt" />
                                <TemplateColumn Title="Status">
                                    <CellTemplate>
                                        <MudChip T="string" Size="Size.Small"
                                                 Color="@(context.Item.Status == UnitStatus.Occupied ? Color.Success :
                                                           context.Item.Status == UnitStatus.Vacant ? Color.Error : Color.Default)">
                                            @context.Item.Status
                                        </MudChip>
                                    </CellTemplate>
                                </TemplateColumn>
                                <PropertyColumn Property="x => x.MarketRent" Title="Market Rent" Format="C0" />
                                <PropertyColumn Property="x => x.ActualRent" Title="Actual Rent" Format="C0" />
                                <PropertyColumn Property="x => x.TenantName" Title="Tenant" />
                                <TemplateColumn Title="Lease End">
                                    <CellTemplate>
                                        @(context.Item.LeaseEnd?.ToString("MM/dd/yy") ?? "â€”")
                                    </CellTemplate>
                                </TemplateColumn>
                                <TemplateColumn>
                                    <CellTemplate>
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small"
                                                       OnClick="@(() => DeleteRentRollUnitAsync(context.Item.Id))" />
                                    </CellTemplate>
                                </TemplateColumn>
                            </Columns>
                        </MudDataGrid>
                    }
                    else if (!_showUnitForm)
                    {
                        <MudStack AlignItems="AlignItems.Center" Class="pa-8">
                            <MudIcon Icon="@Icons.Material.Filled.Apartment" Size="Size.Large" Style="color: #D1D5DB;" />
                            <MudText Typo="Typo.body1" Style="color: #6B7280;">No units added yet</MudText>
                            <MudText Typo="Typo.body2" Style="color: #9CA3AF;">
                                Add individual units to track tenants, rents, and lease terms.
                            </MudText>
                        </MudStack>
                    }
                </div>
            </MudTabPanel>

            <MudTabPanel Text="Actuals" Icon="@Icons.Material.Filled.ReceiptLong">
                <div class="deal-tab-content">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                        <MudText Typo="Typo.h6" Style="font-weight: 600; color: #1A2332;">Monthly Actuals â€” @_actualsYear</MudText>
                        <MudStack Row="true" Spacing="2">
                            <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft"
                                           OnClick="@(() => ChangeActualsYear(-1))" />
                            <MudIconButton Icon="@Icons.Material.Filled.ChevronRight"
                                           OnClick="@(() => ChangeActualsYear(1))" />
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.Add"
                                       OnClick="@(() => _showActualForm = true)"
                                       Style="text-transform: none;">
                                Add Month
                            </MudButton>
                        </MudStack>
                    </MudStack>

                    @if (_annualSummary is not null && _annualSummary.MonthsReported > 0)
                    {
                        <MudGrid Class="mb-4">
                            <MudItem xs="6" md="3">
                                <MudPaper Elevation="0" Class="pa-3" Style="border: 1px solid #E5E7EB; border-radius: 8px; text-align: center;">
                                    <MudText Typo="Typo.caption" Style="color: #6B7280;">YTD Revenue</MudText>
                                    <MudText Typo="Typo.h6" Style="font-weight: 700;">@_annualSummary.TotalRevenue.ToString("C0")</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" md="3">
                                <MudPaper Elevation="0" Class="pa-3" Style="border: 1px solid #E5E7EB; border-radius: 8px; text-align: center;">
                                    <MudText Typo="Typo.caption" Style="color: #6B7280;">YTD NOI</MudText>
                                    <MudText Typo="Typo.h6" Style="font-weight: 700;">@_annualSummary.TotalNoi.ToString("C0")</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" md="3">
                                <MudPaper Elevation="0" Class="pa-3" Style="border: 1px solid #E5E7EB; border-radius: 8px; text-align: center;">
                                    <MudText Typo="Typo.caption" Style="color: #6B7280;">YTD Cash Flow</MudText>
                                    <MudText Typo="Typo.h6" Style="font-weight: 700;">@_annualSummary.TotalCashFlow.ToString("C0")</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" md="3">
                                <MudPaper Elevation="0" Class="pa-3" Style="border: 1px solid #E5E7EB; border-radius: 8px; text-align: center;">
                                    <MudText Typo="Typo.caption" Style="color: #6B7280;">Avg Occupancy</MudText>
                                    <MudText Typo="Typo.h6" Style="font-weight: 700;">@_annualSummary.AverageOccupancy.ToString("F1")%</MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>
                    }

                    @if (_showActualForm)
                    {
                        <MudPaper Elevation="0" Class="pa-4 mb-4" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                            <MudText Typo="Typo.subtitle1" Class="mb-3" Style="font-weight: 600;">Enter Monthly Data</MudText>
                            <MudGrid>
                                <MudItem xs="6" md="2">
                                    <MudSelect @bind-Value="_newActualMonth" Label="Month" Variant="Variant.Outlined">
                                        @for (int m = 1; m <= 12; m++)
                                        {
                                            var month = m;
                                            <MudSelectItem Value="@month">@(new DateTime(2026, month, 1).ToString("MMM"))</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem xs="6" md="2">
                                    <MudNumericField @bind-Value="_newActualGri" Label="Gross Rental Income" Variant="Variant.Outlined"
                                                     Adornment="Adornment.Start" AdornmentText="$" />
                                </MudItem>
                                <MudItem xs="6" md="2">
                                    <MudNumericField @bind-Value="_newActualVacancy" Label="Vacancy Loss" Variant="Variant.Outlined"
                                                     Adornment="Adornment.Start" AdornmentText="$" />
                                </MudItem>
                                <MudItem xs="6" md="2">
                                    <MudNumericField @bind-Value="_newActualExpenses" Label="Total OpEx" Variant="Variant.Outlined"
                                                     Adornment="Adornment.Start" AdornmentText="$" />
                                </MudItem>
                                <MudItem xs="6" md="2">
                                    <MudNumericField @bind-Value="_newActualDebtService" Label="Debt Service" Variant="Variant.Outlined"
                                                     Adornment="Adornment.Start" AdornmentText="$" />
                                </MudItem>
                                <MudItem xs="6" md="2">
                                    <MudNumericField @bind-Value="_newActualOccupied" Label="Occupied Units" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" Class="d-flex justify-end gap-2">
                                    <MudButton Variant="Variant.Text" OnClick="@(() => _showActualForm = false)"
                                               Style="text-transform: none;">Cancel</MudButton>
                                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                               OnClick="SaveActualAsync"
                                               Style="text-transform: none;">Save</MudButton>
                                </MudItem>
                            </MudGrid>
                        </MudPaper>
                    }

                    @if (_yearActuals.Count > 0)
                    {
                        <MudSimpleTable Dense="true" Hover="true" Elevation="0" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th style="text-align: right;">EGI</th>
                                    <th style="text-align: right;">OpEx</th>
                                    <th style="text-align: right;">NOI</th>
                                    <th style="text-align: right;">Cash Flow</th>
                                    <th style="text-align: right;">Occupancy</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var a in _yearActuals)
                                {
                                    <tr>
                                        <td>@(new DateTime(a.Year, a.Month, 1).ToString("MMM yyyy"))</td>
                                        <td style="text-align: right;">@a.EffectiveGrossIncome.ToString("C0")</td>
                                        <td style="text-align: right;">@a.TotalOperatingExpenses.ToString("C0")</td>
                                        <td style="text-align: right; font-weight: 600;">@a.NetOperatingIncome.ToString("C0")</td>
                                        <td style="text-align: right;">@a.CashFlow.ToString("C0")</td>
                                        <td style="text-align: right;">@a.OccupancyPercent.ToString("F1")%</td>
                                        <td>
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small"
                                                           OnClick="@(() => DeleteActualAsync(a.Id))" />
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </MudSimpleTable>
                    }
                    else
                    {
                        <MudStack AlignItems="AlignItems.Center" Class="pa-8">
                            <MudIcon Icon="@Icons.Material.Filled.ReceiptLong" Size="Size.Large" Style="color: #D1D5DB;" />
                            <MudText Typo="Typo.body1" Style="color: #6B7280;">No actuals for @_actualsYear</MudText>
                        </MudStack>
                    }
                </div>
            </MudTabPanel>

            <MudTabPanel Text="Performance" Icon="@Icons.Material.Filled.TrendingUp">
                <div class="deal-tab-content">
                    <MudStack AlignItems="AlignItems.Center" Class="pa-8">
                        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Large" Style="color: #D1D5DB;" />
                        <MudText Typo="Typo.h6" Style="color: #6B7280;">Variance & Performance</MudText>
                        <MudText Typo="Typo.body2" Style="color: #9CA3AF;">
                            Compare underwriting projections to actual performance. Coming in Track 5.
                        </MudText>
                    </MudStack>
                </div>
            </MudTabPanel>

            <MudTabPanel Text="CapEx" Icon="@Icons.Material.Filled.Construction">
                <div class="deal-tab-content">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                        <MudText Typo="Typo.h6" Style="font-weight: 600; color: #1A2332;">Capital Expenditures</MudText>
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   OnClick="@(() => _showCapExForm = true)"
                                   Style="text-transform: none;">
                            Add Project
                        </MudButton>
                    </MudStack>

                    @if (_capExProjects.Count > 0)
                    {
                        <MudGrid Class="mb-4">
                            <MudItem xs="6" md="4">
                                <MudPaper Elevation="0" Class="pa-3" Style="border: 1px solid #E5E7EB; border-radius: 8px; text-align: center;">
                                    <MudText Typo="Typo.caption" Style="color: #6B7280;">Total Budget</MudText>
                                    <MudText Typo="Typo.h6" Style="font-weight: 700;">@_capExProjects.Sum(p => p.BudgetAmount).ToString("C0")</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" md="4">
                                <MudPaper Elevation="0" Class="pa-3" Style="border: 1px solid #E5E7EB; border-radius: 8px; text-align: center;">
                                    <MudText Typo="Typo.caption" Style="color: #6B7280;">Total Spent</MudText>
                                    <MudText Typo="Typo.h6" Style="font-weight: 700;">@_capExProjects.Sum(p => p.ActualSpend).ToString("C0")</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" md="4">
                                <MudPaper Elevation="0" Class="pa-3" Style="border: 1px solid #E5E7EB; border-radius: 8px; text-align: center;">
                                    <MudText Typo="Typo.caption" Style="color: #6B7280;">Projects</MudText>
                                    <MudText Typo="Typo.h6" Style="font-weight: 700;">@_capExProjects.Count</MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>
                    }

                    @if (_showCapExForm)
                    {
                        <MudPaper Elevation="0" Class="pa-4 mb-4" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                            <MudGrid>
                                <MudItem xs="12" md="4">
                                    <MudTextField @bind-Value="_newCapExName" Label="Project Name" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="6" md="3">
                                    <MudNumericField @bind-Value="_newCapExBudget" Label="Budget" Variant="Variant.Outlined"
                                                     Adornment="Adornment.Start" AdornmentText="$" />
                                </MudItem>
                                <MudItem xs="6" md="2">
                                    <MudNumericField @bind-Value="_newCapExUnits" Label="Units Affected" Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" md="3" Class="d-flex align-end gap-2">
                                    <MudButton Variant="Variant.Text" OnClick="@(() => _showCapExForm = false)"
                                               Style="text-transform: none;">Cancel</MudButton>
                                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                               OnClick="AddCapExProjectAsync"
                                               Style="text-transform: none;">Add</MudButton>
                                </MudItem>
                            </MudGrid>
                        </MudPaper>
                    }

                    @foreach (var project in _capExProjects)
                    {
                        <MudCard Elevation="0" Class="mb-3" Style="border: 1px solid #E5E7EB; border-radius: 8px;">
                            <MudCardContent>
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">@project.Name</MudText>
                                        @if (project.UnitsAffected.HasValue)
                                        {
                                            <MudText Typo="Typo.caption" Style="color: #6B7280;">@project.UnitsAffected units affected</MudText>
                                        }
                                    </MudStack>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudChip T="string" Size="Size.Small"
                                                 Color="@(project.Status == CapExStatus.Complete ? Color.Success :
                                                           project.Status == CapExStatus.InProgress ? Color.Info :
                                                           project.Status == CapExStatus.Cancelled ? Color.Error : Color.Default)">
                                            @project.Status
                                        </MudChip>
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small"
                                                       OnClick="@(() => DeleteCapExProjectAsync(project.Id))" />
                                    </MudStack>
                                </MudStack>
                                <MudProgressLinear Color="@(project.BudgetUtilizationPercent > 100 ? Color.Error : Color.Primary)"
                                                   Value="@((double)Math.Min(project.BudgetUtilizationPercent, 100))"
                                                   Class="my-2" />
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.body2" Style="color: #6B7280;">
                                        @project.ActualSpend.ToString("C0") of @project.BudgetAmount.ToString("C0")
                                    </MudText>
                                    <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                        @project.BudgetUtilizationPercent.ToString("F0")%
                                    </MudText>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    }

                    @if (_capExProjects.Count == 0 && !_showCapExForm)
                    {
                        <MudStack AlignItems="AlignItems.Center" Class="pa-8">
                            <MudIcon Icon="@Icons.Material.Filled.Construction" Size="Size.Large" Style="color: #D1D5DB;" />
                            <MudText Typo="Typo.body1" Style="color: #6B7280;">No CapEx projects</MudText>
                            <MudText Typo="Typo.body2" Style="color: #9CA3AF;">
                                Track renovation projects, budgets, and ROI.
                            </MudText>
                        </MudStack>
                    }
                </div>
            </MudTabPanel>
        }

        @if (_deal.Phase >= DealPhase.Exit)
        {
            <MudTabPanel Text="Disposition" Icon="@Icons.Material.Filled.Sell">
                <div class="deal-tab-content">
                    <MudStack AlignItems="AlignItems.Center" Class="pa-8">
                        <MudIcon Icon="@Icons.Material.Filled.Sell" Size="Size.Large" Style="color: #D1D5DB;" />
                        <MudText Typo="Typo.h6" Style="color: #6B7280;">Disposition Analysis</MudText>
                        <MudText Typo="Typo.body2" Style="color: #9CA3AF;">
                            Hold/sell/refinance scenarios with realized returns. Coming in Track 9.
                        </MudText>
                    </MudStack>
                </div>
            </MudTabPanel>
        }

    </MudTabs>

    @if (_chatOpen)
    {
        <div class="deal-chat-panel">
            <div class="deal-chat-panel-header">
                <MudText Typo="Typo.subtitle1" Style="font-weight: 600; color: #1A2332;">Chat</MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Close"
                               Size="Size.Small" Color="Color.Default"
                               OnClick="ToggleChat" />
            </div>
            <DealChatTab DealId="DealId" OnDealUpdated="RefreshDealData" MarketContext="_marketContext" />
        </div>
    }
    </div>
}

@code {
    [Parameter] public Guid DealId { get; set; }
    [SupplyParameterFromQuery(Name = "tab")]
    public string? Tab { get; set; }

    private Deal? _deal;
    private Property _property = null!;
    private CalculationResult? _calc;
    private List<SensitivityScenario> _sensitivityScenarios = new();
    private List<CapitalStackItem> _capitalStack = new();
    private List<DealChecklistItem> _checklistItems = new();
    private List<UploadedDocument> _documents = new();
    private List<DealInvestor> _investors = new();
    private List<EmailIngestionLog> _ingestionLogs = new();
    private bool _loading = true;
    private bool _saving;
    private int _activePanelIndex;
    private bool _chatOpen;
    private MarketContextDto? _marketContext;
    private string _userId = string.Empty;
    private Guid? _uploadingItemId;

    // Contract tab (Track 6)
    private ContractTimeline? _contractTimeline;
    private List<ClosingCostItem> _closingCosts = new();
    private DateTime? _contractLoiDate;
    private DateTime? _contractPsaDate;
    private DateTime? _contractInspectionDate;
    private DateTime? _contractFinancingDate;
    private DateTime? _contractAppraisalDate;
    private DateTime? _contractTitleDate;
    private DateTime? _contractClosingDate;
    private DateTime? _contractActualClosingDate;
    private decimal? _contractEarnestMoney;
    private string? _contractLenderName;
    private string? _contractTitleCompany;
    private bool _showClosingCostForm;
    private string _newCostCategory = "Title";
    private string _newCostDescription = "";
    private decimal _newCostEstimated;

    // Rent Roll tab (Track 3)
    private List<RentRollUnit> _rentRollUnits = new();
    private RentRollSummaryDto? _rentRollSummary;
    private bool _showUnitForm;
    private string _newUnitNumber = "";
    private int _newUnitBeds;
    private int _newUnitBaths;
    private int? _newUnitSqFt;
    private decimal _newUnitMarketRent;
    private UnitStatus _newUnitStatus = UnitStatus.Vacant;
    private string? _newUnitTenant;

    // Actuals tab (Track 4)
    private List<MonthlyActual> _yearActuals = new();
    private AnnualSummaryDto? _annualSummary;
    private int _actualsYear = DateTime.UtcNow.Year;
    private bool _showActualForm;
    private int _newActualMonth = DateTime.UtcNow.Month;
    private decimal _newActualGri;
    private decimal _newActualVacancy;
    private decimal _newActualExpenses;
    private decimal _newActualDebtService;
    private int _newActualOccupied;

    // CapEx tab (Track 7)
    private List<CapExProject> _capExProjects = new();
    private bool _showCapExForm;
    private string _newCapExName = "";
    private decimal _newCapExBudget;
    private int? _newCapExUnits;

    private string DealIngestEmail => $"deal-{_deal?.ShortCode}@ingest.zsrunderwriting.com";

    // New capital stack item form
    private CapitalSource _newCapSource = CapitalSource.SeniorDebt;
    private decimal _newCapAmount;
    private decimal? _newCapRate;
    private int? _newCapTerm;

    // Investor form
    private bool _showInvestorForm;
    private Guid? _editingInvestorId;
    private string _invName = "";
    private string? _invCompany;
    private string? _invRole;
    private string? _invEmail;
    private string? _invPhone;
    private string? _invAddress;
    private string? _invCity;
    private string? _invState;
    private string? _invZip;
    private decimal? _invNetWorth;
    private decimal? _invLiquidity;
    private string? _invNotes;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        _userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier) ?? string.Empty;

        _deal = await Db.Deals
            .Include(d => d.Property)
            .Include(d => d.CalculationResult)
            .Include(d => d.CapitalStackItems)
            .Include(d => d.DealChecklistItems).ThenInclude(i => i.Template)
            .Include(d => d.DealChecklistItems).ThenInclude(i => i.Document)
            .Include(d => d.UploadedDocuments)
            .Include(d => d.DealInvestors)
            .FirstOrDefaultAsync(d => d.Id == DealId);

        if (_deal is not null)
        {
            _property = _deal.Property ?? new Property(_deal.Address, _deal.UnitCount > 0 ? _deal.UnitCount : 1);
            _calc = _deal.CalculationResult;
            ComputeSensitivityScenarios();
            _capitalStack = _deal.CapitalStackItems.OrderBy(c => c.SortOrder).ToList();

            // Auto-generate checklist items on first visit
            if (!_deal.DealChecklistItems.Any())
            {
                await GenerateChecklistItems();
            }

            _checklistItems = _deal.DealChecklistItems
                .GroupBy(i => i.ChecklistTemplateId)
                .Select(g => g.First())
                .OrderBy(i => i.Template.SectionOrder)
                .ThenBy(i => i.Template.SortOrder)
                .ToList();

            _documents = _deal.UploadedDocuments.OrderByDescending(d => d.UploadedAt).ToList();
            _investors = _deal.DealInvestors.OrderBy(i => i.Name).ToList();
            _ingestionLogs = await Db.EmailIngestionLogs
                .Where(l => l.DealId == DealId)
                .OrderByDescending(l => l.CreatedAt)
                .Take(20)
                .ToListAsync();
        }

        // Handle tab query parameter
        if (!string.IsNullOrEmpty(Tab))
        {
            if (Tab.Equals("chat", StringComparison.OrdinalIgnoreCase))
            {
                _chatOpen = true;
            }
            else
            {
                _activePanelIndex = Tab.ToLowerInvariant() switch
                {
                    "general" => 0,
                    "underwriting" => 1,
                    "investors" => 2,
                    "checklist" => 3,
                    "documents" => 4,
                    _ => 0
                };
            }
        }

        // Load phase-gated data
        if (_deal is not null)
        {
            if (_deal.Phase >= DealPhase.Contract)
            {
                _contractTimeline = await ContractService.GetOrCreateTimelineAsync(_deal.Id);
                _closingCosts = (await ContractService.GetClosingCostsAsync(_deal.Id)).ToList();
                BindContractFields();
            }
            if (_deal.Phase >= DealPhase.Ownership)
            {
                _rentRollUnits = (await RentRollService.GetUnitsForDealAsync(_deal.Id)).ToList();
                _rentRollSummary = await RentRollService.GetSummaryAsync(_deal.Id);
                await RefreshActualsData();
                _capExProjects = (await CapExService.GetProjectsAsync(_deal.Id)).ToList();
            }
        }

        _loading = false;
    }

    private void BindContractFields()
    {
        if (_contractTimeline is null) return;
        _contractLoiDate = _contractTimeline.LoiDate;
        _contractPsaDate = _contractTimeline.PsaExecutedDate;
        _contractInspectionDate = _contractTimeline.InspectionDeadline;
        _contractFinancingDate = _contractTimeline.FinancingContingencyDate;
        _contractAppraisalDate = _contractTimeline.AppraisalDeadline;
        _contractTitleDate = _contractTimeline.TitleDeadline;
        _contractClosingDate = _contractTimeline.ClosingDate;
        _contractActualClosingDate = _contractTimeline.ActualClosingDate;
        _contractEarnestMoney = _contractTimeline.EarnestMoneyDeposit;
        _contractLenderName = _contractTimeline.LenderName;
        _contractTitleCompany = _contractTimeline.TitleCompany;
    }

    private (string Name, DateTime Date, int Days)? GetNextContractDeadline()
    {
        var next = _contractTimeline?.GetNextDeadline();
        if (next is null) return null;
        return (next.Value.Name, next.Value.Date, (next.Value.Date - DateTime.UtcNow).Days);
    }

    private async Task SaveContractTimelineAsync()
    {
        if (_contractTimeline is null) return;
        _contractTimeline.LoiDate = _contractLoiDate;
        _contractTimeline.PsaExecutedDate = _contractPsaDate;
        _contractTimeline.InspectionDeadline = _contractInspectionDate;
        _contractTimeline.FinancingContingencyDate = _contractFinancingDate;
        _contractTimeline.AppraisalDeadline = _contractAppraisalDate;
        _contractTimeline.TitleDeadline = _contractTitleDate;
        _contractTimeline.ClosingDate = _contractClosingDate;
        _contractTimeline.ActualClosingDate = _contractActualClosingDate;
        _contractTimeline.EarnestMoneyDeposit = _contractEarnestMoney;
        _contractTimeline.LenderName = _contractLenderName;
        _contractTimeline.TitleCompany = _contractTitleCompany;
        await ContractService.UpdateTimelineAsync(_contractTimeline);
        Snackbar.Add("Contract timeline saved.", Severity.Success);
    }

    private async Task AddClosingCostAsync()
    {
        if (string.IsNullOrWhiteSpace(_newCostDescription) || _newCostEstimated <= 0) return;
        var item = new ClosingCostItem(DealId, _newCostCategory, _newCostDescription, _newCostEstimated);
        await ContractService.AddClosingCostAsync(item);
        _closingCosts = (await ContractService.GetClosingCostsAsync(DealId)).ToList();
        _newCostDescription = "";
        _newCostEstimated = 0;
        _showClosingCostForm = false;
    }

    private async Task ToggleClosingCostPaidAsync(ClosingCostItem cost, bool paid)
    {
        cost.IsPaid = paid;
        await ContractService.UpdateClosingCostAsync(cost);
    }

    private async Task DeleteClosingCostAsync(Guid itemId)
    {
        await ContractService.DeleteClosingCostAsync(itemId);
        _closingCosts = (await ContractService.GetClosingCostsAsync(DealId)).ToList();
    }

    // === Rent Roll methods ===

    private async Task AddRentRollUnitAsync()
    {
        if (string.IsNullOrWhiteSpace(_newUnitNumber) || _newUnitMarketRent <= 0) return;
        var unit = new RentRollUnit(DealId, _newUnitNumber, _newUnitMarketRent)
        {
            Bedrooms = _newUnitBeds,
            Bathrooms = _newUnitBaths,
            SquareFeet = _newUnitSqFt,
            Status = _newUnitStatus,
            TenantName = _newUnitTenant
        };
        await RentRollService.AddUnitAsync(unit);
        await RefreshRentRollData();
        ResetUnitForm();
    }

    private async Task DeleteRentRollUnitAsync(Guid unitId)
    {
        await RentRollService.DeleteUnitAsync(unitId);
        await RefreshRentRollData();
    }

    private async Task RefreshRentRollData()
    {
        _rentRollUnits = (await RentRollService.GetUnitsForDealAsync(DealId)).ToList();
        _rentRollSummary = await RentRollService.GetSummaryAsync(DealId);
    }

    private void ResetUnitForm()
    {
        _newUnitNumber = "";
        _newUnitBeds = 0;
        _newUnitBaths = 0;
        _newUnitSqFt = null;
        _newUnitMarketRent = 0;
        _newUnitStatus = UnitStatus.Vacant;
        _newUnitTenant = null;
        _showUnitForm = false;
    }

    // === Actuals methods ===

    private async Task RefreshActualsData()
    {
        _yearActuals = (await ActualsService.GetForYearAsync(DealId, _actualsYear)).ToList();
        _annualSummary = await ActualsService.GetAnnualSummaryAsync(DealId, _actualsYear);
    }

    private async Task ChangeActualsYear(int delta)
    {
        _actualsYear += delta;
        await RefreshActualsData();
    }

    private async Task SaveActualAsync()
    {
        if (_newActualGri <= 0) return;
        var actual = new MonthlyActual(DealId, _actualsYear, _newActualMonth)
        {
            GrossRentalIncome = _newActualGri,
            VacancyLoss = _newActualVacancy,
            PropertyTaxes = _newActualExpenses * 0.25m,
            Insurance = _newActualExpenses * 0.1m,
            Utilities = _newActualExpenses * 0.15m,
            Repairs = _newActualExpenses * 0.1m,
            Management = _newActualExpenses * 0.2m,
            OtherExpenses = _newActualExpenses * 0.2m,
            DebtService = _newActualDebtService,
            OccupiedUnits = _newActualOccupied,
            TotalUnits = _deal?.UnitCount ?? 0
        };
        await ActualsService.SaveAsync(actual);
        await RefreshActualsData();
        _showActualForm = false;
        Snackbar.Add($"Actuals saved for {new DateTime(_actualsYear, _newActualMonth, 1):MMM yyyy}.", Severity.Success);
    }

    private async Task DeleteActualAsync(Guid id)
    {
        await ActualsService.DeleteAsync(id);
        await RefreshActualsData();
    }

    // === CapEx methods ===

    private async Task AddCapExProjectAsync()
    {
        if (string.IsNullOrWhiteSpace(_newCapExName) || _newCapExBudget <= 0) return;
        var project = new CapExProject(DealId, _newCapExName, _newCapExBudget)
        {
            UnitsAffected = _newCapExUnits
        };
        await CapExService.AddProjectAsync(project);
        _capExProjects = (await CapExService.GetProjectsAsync(DealId)).ToList();
        _newCapExName = "";
        _newCapExBudget = 0;
        _newCapExUnits = null;
        _showCapExForm = false;
    }

    private async Task DeleteCapExProjectAsync(Guid projectId)
    {
        await CapExService.DeleteProjectAsync(projectId);
        _capExProjects = (await CapExService.GetProjectsAsync(DealId)).ToList();
    }

    private async Task RefreshDealData()
    {
        if (_deal is null) return;

        // Reload deal with all related data
        await Db.Entry(_deal).ReloadAsync();
        await Db.Entry(_deal).Collection(d => d.CapitalStackItems).LoadAsync();
        await Db.Entry(_deal).Reference(d => d.CalculationResult).LoadAsync();
        await Db.Entry(_deal).Reference(d => d.Property).LoadAsync();
        await Db.Entry(_deal).Collection(d => d.DealChecklistItems).LoadAsync();
        foreach (var item in _deal.DealChecklistItems)
            await Db.Entry(item).Reference(i => i.Template).LoadAsync();
        await Db.Entry(_deal).Collection(d => d.UploadedDocuments).LoadAsync();
        await Db.Entry(_deal).Collection(d => d.DealInvestors).LoadAsync();

        _property = _deal.Property ?? new Property(_deal.Address, _deal.UnitCount > 0 ? _deal.UnitCount : 1);
        _calc = _deal.CalculationResult;
        ComputeSensitivityScenarios();
        _capitalStack = _deal.CapitalStackItems.OrderBy(c => c.SortOrder).ToList();
        _checklistItems = _deal.DealChecklistItems
            .OrderBy(i => i.Template.SectionOrder)
            .ThenBy(i => i.Template.SortOrder)
            .ToList();
        _documents = _deal.UploadedDocuments.OrderByDescending(d => d.UploadedAt).ToList();
        _investors = _deal.DealInvestors.OrderBy(i => i.Name).ToList();
        _ingestionLogs = await Db.EmailIngestionLogs
            .Where(l => l.DealId == _deal.Id)
            .OrderByDescending(l => l.CreatedAt)
            .Take(20)
            .ToListAsync();

        await InvokeAsync(StateHasChanged);
    }

    private async Task GenerateChecklistItems()
    {
        if (_deal is null) return;

        var templates = await Db.ChecklistTemplates
            .Where(t => t.ExecutionType == ExecutionType.All || t.ExecutionType == _deal.ExecutionType)
            .Where(t => t.TransactionType == "All" || t.TransactionType == _deal.TransactionType)
            .OrderBy(t => t.SectionOrder).ThenBy(t => t.SortOrder)
            .ToListAsync();

        var existingTemplateIds = _deal.DealChecklistItems
            .Select(ci => ci.ChecklistTemplateId)
            .ToHashSet();

        foreach (var template in templates)
        {
            if (existingTemplateIds.Contains(template.Id)) continue;

            var item = new DealChecklistItem(_deal.Id, template.Id);
            item.Template = template;
            Db.DealChecklistItems.Add(item);
            _deal.DealChecklistItems.Add(item);
        }

        await Db.SaveChangesAsync();
    }

    private void OnTabChanged(int index)
    {
        _activePanelIndex = index;
    }

    private async Task ToggleChat()
    {
        _chatOpen = !_chatOpen;

        // Lazy-load market context on first chat open
        if (_chatOpen && _marketContext == null && _deal != null)
        {
            try
            {
                var (city, state) = ParseCityState(_deal.Address);
                if (!string.IsNullOrEmpty(city) && !string.IsNullOrEmpty(state))
                {
                    _marketContext = await MarketDataService.GetMarketContextForDealAsync(_deal.Id, city, state);
                }
            }
            catch
            {
                // Market data is supplementary â€” don't block chat on failure
            }
        }
    }

    private static (string city, string state) ParseCityState(string? address)
    {
        if (string.IsNullOrWhiteSpace(address))
            return (string.Empty, string.Empty);

        var parts = address.Split(',', StringSplitOptions.TrimEntries | StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 3)
            return (parts[^2], parts[^1]);
        if (parts.Length == 2)
            return (parts[0], parts[1]);

        return (string.Empty, string.Empty);
    }

    private async Task SaveGeneralAsync()
    {
        if (_deal is null) return;

        _saving = true;
        try
        {
            if (_deal.Property is null && _property is not null)
            {
                _property.DealId = _deal.Id;
                Db.Properties.Add(_property);
                _deal.Property = _property;
            }

            await Db.SaveChangesAsync();
            Snackbar.Add("Changes saved", Severity.Success);
        }
        catch (Exception)
        {
            Snackbar.Add("Failed to save changes", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task AddCapitalStackItem()
    {
        if (_deal is null || _newCapAmount <= 0) return;

        var item = new CapitalStackItem(_deal.Id, _newCapSource, _newCapAmount)
        {
            Rate = _newCapRate.HasValue ? _newCapRate.Value / 100m : null,
            TermYears = _newCapTerm,
            SortOrder = _capitalStack.Count
        };

        Db.CapitalStackItems.Add(item);
        await Db.SaveChangesAsync();
        _capitalStack.Add(item);

        // Reset form
        _newCapAmount = 0;
        _newCapRate = null;
        _newCapTerm = null;
        Snackbar.Add("Capital stack item added", Severity.Success);
    }

    private async Task RemoveCapitalStackItem(CapitalStackItem item)
    {
        Db.CapitalStackItems.Remove(item);
        await Db.SaveChangesAsync();
        _capitalStack.Remove(item);
        Snackbar.Add("Capital stack item removed", Severity.Success);
    }

    private void OpenAddInvestorDialog()
    {
        _editingInvestorId = null;
        ResetInvestorForm();
        _showInvestorForm = true;
    }

    private void OpenEditInvestorDialog(DealInvestor investor)
    {
        _editingInvestorId = investor.Id;
        _invName = investor.Name;
        _invCompany = investor.Company;
        _invRole = investor.Role;
        _invEmail = investor.Email;
        _invPhone = investor.Phone;
        _invAddress = investor.Address;
        _invCity = investor.City;
        _invState = investor.State;
        _invZip = investor.Zip;
        _invNetWorth = investor.NetWorth;
        _invLiquidity = investor.Liquidity;
        _invNotes = investor.Notes;
        _showInvestorForm = true;
    }

    private void CancelInvestorForm()
    {
        _showInvestorForm = false;
        ResetInvestorForm();
    }

    private void ResetInvestorForm()
    {
        _invName = "";
        _invCompany = null;
        _invRole = null;
        _invEmail = null;
        _invPhone = null;
        _invAddress = null;
        _invCity = null;
        _invState = null;
        _invZip = null;
        _invNetWorth = null;
        _invLiquidity = null;
        _invNotes = null;
    }

    private async Task SaveInvestor()
    {
        if (_deal is null || string.IsNullOrWhiteSpace(_invName)) return;

        if (_editingInvestorId.HasValue)
        {
            var investor = _investors.FirstOrDefault(i => i.Id == _editingInvestorId.Value);
            if (investor is not null)
            {
                investor.Name = _invName;
                investor.Company = _invCompany;
                investor.Role = _invRole;
                investor.Email = _invEmail;
                investor.Phone = _invPhone;
                investor.Address = _invAddress;
                investor.City = _invCity;
                investor.State = _invState;
                investor.Zip = _invZip;
                investor.NetWorth = _invNetWorth;
                investor.Liquidity = _invLiquidity;
                investor.Notes = _invNotes;
                await Db.SaveChangesAsync();
                Snackbar.Add("Investor updated", Severity.Success);
            }
        }
        else
        {
            var investor = new DealInvestor(_deal.Id, _invName)
            {
                Company = _invCompany,
                Role = _invRole,
                Email = _invEmail,
                Phone = _invPhone,
                Address = _invAddress,
                City = _invCity,
                State = _invState,
                Zip = _invZip,
                NetWorth = _invNetWorth,
                Liquidity = _invLiquidity,
                Notes = _invNotes
            };
            Db.DealInvestors.Add(investor);
            await Db.SaveChangesAsync();
            _investors.Add(investor);
            _investors = _investors.OrderBy(i => i.Name).ToList();
            Snackbar.Add("Investor added", Severity.Success);
        }

        _showInvestorForm = false;
        ResetInvestorForm();
    }

    private async Task DeleteInvestor(DealInvestor investor)
    {
        Db.DealInvestors.Remove(investor);
        await Db.SaveChangesAsync();
        _investors.Remove(investor);
        Snackbar.Add("Investor removed", Severity.Success);
    }

    private async Task UpdateChecklistStatus(DealChecklistItem item, ChecklistStatus newStatus)
    {
        item.UpdateStatus(newStatus);
        await Db.SaveChangesAsync();
    }

    private async Task OnChecklistFileSelected(DealChecklistItem item, IBrowserFile? file)
    {
        if (file is null || _deal is null) return;

        if (!FileUploadConstants.IsValidExtension(file.Name))
        {
            Snackbar.Add($"File type not allowed: {Path.GetExtension(file.Name)}", Severity.Error);
            return;
        }

        if (!FileUploadConstants.IsValidFileSize(file.Size))
        {
            Snackbar.Add("File exceeds 25 MB limit.", Severity.Error);
            return;
        }

        _uploadingItemId = item.Id;
        StateHasChanged();

        try
        {
            using var stream = file.OpenReadStream(maxAllowedSize: FileUploadConstants.MaxFileSizeBytes);
            using var buffer = new MemoryStream();
            await stream.CopyToAsync(buffer);
            buffer.Position = 0;

            var docType = DetectDocumentType(file.Name);
            var result = await UploadService.UploadDocumentAsync(
                DealId, buffer, file.Name, docType, _userId);

            // Link this document directly to the checklist item
            item.MarkSatisfied(result.DocumentId);
            await Db.SaveChangesAsync();

            Snackbar.Add($"Uploaded and linked: {file.Name}", Severity.Success);
            await ActivityTracker.TrackEventAsync(ActivityEventType.DocumentUploaded, dealId: DealId, metadata: file.Name);

            // Refresh to show the download icon and updated status
            await RefreshDealData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Upload failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _uploadingItemId = null;
            StateHasChanged();
        }
    }

    private async Task ReassignDocumentAsync(DealChecklistItem source, DealChecklistItem target)
    {
        if (source.DocumentId is null) return;

        var docId = source.DocumentId.Value;
        source.UnlinkDocument();
        target.MarkSatisfied(docId);
        await Db.SaveChangesAsync();

        Snackbar.Add($"Document reassigned to: {target.Template.ItemName}", Severity.Success);
        await RefreshDealData();
    }

    private async Task UnlinkDocumentAsync(DealChecklistItem item)
    {
        item.UnlinkDocument();
        await Db.SaveChangesAsync();

        Snackbar.Add("Document unlinked from checklist item.", Severity.Info);
        await RefreshDealData();
    }

    private static DocumentType DetectDocumentType(string fileName)
    {
        var name = Path.GetFileNameWithoutExtension(fileName).ToLowerInvariant();
        if (name.Contains("rent") && name.Contains("roll")) return DocumentType.RentRoll;
        if (name.Contains("t12") || name.Contains("operating") || name.Contains("p&l"))
            return DocumentType.T12PAndL;
        if (name.Contains("loan") || name.Contains("term")) return DocumentType.LoanTermSheet;
        if (name.Contains("offering") || name.Contains("om")) return DocumentType.OfferingMemorandum;
        if (name.Contains("appraisal")) return DocumentType.Appraisal;
        if (name.Contains("phase") || name.Contains("pca")) return DocumentType.PhaseIPCA;
        return DocumentType.OfferingMemorandum;
    }

    private static string FormatChecklistStatus(ChecklistStatus status) => status switch
    {
        ChecklistStatus.Outstanding => "Outstanding",
        ChecklistStatus.UnderReview => "Under Review",
        ChecklistStatus.NeedAdditionalInfo => "Need Info",
        ChecklistStatus.WaiverRequested => "Waiver Req.",
        ChecklistStatus.WaiverApproved => "Waiver OK",
        ChecklistStatus.Satisfied => "Satisfied",
        ChecklistStatus.NotApplicable => "N/A",
        _ => status.ToString()
    };

    private static Color GetChecklistStatusColor(ChecklistStatus status) => status switch
    {
        ChecklistStatus.Outstanding => Color.Default,
        ChecklistStatus.UnderReview => Color.Warning,
        ChecklistStatus.NeedAdditionalInfo => Color.Info,
        ChecklistStatus.WaiverRequested => Color.Secondary,
        ChecklistStatus.WaiverApproved => Color.Tertiary,
        ChecklistStatus.Satisfied => Color.Success,
        ChecklistStatus.NotApplicable => Color.Dark,
        _ => Color.Default
    };

    private static string FormatCurrency(decimal? value)
        => value.HasValue ? $"${value.Value:N0}" : "\u2014";

    private static string FormatCurrencyNeg(decimal? value)
        => value.HasValue ? $"(${value.Value:N0})" : "\u2014";

    private static string FormatPercent(decimal? value)
        => value.HasValue ? $"{value.Value * 100:F1}%" : "\u2014";

    private static string FormatMultiple(decimal? value)
        => value.HasValue ? $"{value.Value:F2}x" : "\u2014";

    private static string FormatDelta(decimal value)
        => value == 0m ? "\u2014" : $"{(value > 0 ? "+" : "")}{value:N0}";

    private static string DeltaColor(decimal value)
        => value > 0 ? "#16A34A" : value < 0 ? "#DC2626" : "#6B7280";

    private void ComputeSensitivityScenarios()
    {
        if (_calc is null || _deal is null) return;
        var gpr = _calc.GrossPotentialRent ?? 0m;
        var occupancy = ProtocolDefaults.GetEffectiveOccupancy(_deal.TargetOccupancy);
        var egi = _calc.EffectiveGrossIncome ?? 0m;
        var opExRatio = egi > 0 ? (_calc.OperatingExpenses ?? 0m) / egi : 0.5435m;
        var exitCapPct = (_calc.ExitCapRate ?? 0.07m) * 100m;
        var noi = _calc.NetOperatingIncome ?? 0m;
        var debtService = _calc.AnnualDebtService ?? 0m;
        var reserves = _deal.UnitCount * 250m;
        var equity = _deal.PurchasePrice - (_calc.LoanAmount ?? 0m);
        _sensitivityScenarios = SensitivityCalc.RunScenarios(
            gpr, occupancy, 0.135m, opExRatio, _deal.PurchasePrice,
            debtService, reserves, equity, exitCapPct, noi);
    }

    private static string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }

    private static string GetDocIcon(string fileName)
    {
        var ext = Path.GetExtension(fileName).ToLowerInvariant();
        return ext switch
        {
            ".pdf" => Icons.Material.Filled.PictureAsPdf,
            ".xlsx" or ".csv" => Icons.Material.Filled.TableChart,
            ".docx" => Icons.Material.Filled.Article,
            _ => Icons.Material.Filled.InsertDriveFile
        };
    }

    private async Task CopyDealEmailAsync()
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", DealIngestEmail);
        Snackbar.Add("Email address copied!", Severity.Info);
    }

    private static Color GetStatusColor(string status) => status switch
    {
        "Draft" => Color.Default,
        "InProgress" or "Screening" => Color.Warning,
        "Complete" => Color.Success,
        "Archived" => Color.Dark,
        "UnderContract" => Color.Info,
        "Closed" => Color.Tertiary,
        "Active" => Color.Success,
        "Disposition" => Color.Warning,
        "Sold" => Color.Dark,
        _ => Color.Default
    };

    private static string GetStatusDisplayName(DealStatus status) => status switch
    {
        DealStatus.InProgress => "Screening",
        DealStatus.UnderContract => "Under Contract",
        _ => status.ToString()
    };

    /// <summary>
    /// Returns the next logical status transition label and target, or (null, default) if none.
    /// </summary>
    private static (string? Label, DealStatus Target) GetNextTransition(DealStatus current) => current switch
    {
        DealStatus.Draft => ("Start Screening", DealStatus.Screening),
        DealStatus.InProgress => ("Mark Complete", DealStatus.Complete),
        DealStatus.Screening => ("Mark Complete", DealStatus.Complete),
        DealStatus.Complete => ("Move to Under Contract", DealStatus.UnderContract),
        DealStatus.UnderContract => ("Mark Closed", DealStatus.Closed),
        DealStatus.Closed => ("Activate Asset", DealStatus.Active),
        DealStatus.Active => ("Begin Disposition", DealStatus.Disposition),
        DealStatus.Disposition => ("Mark Sold", DealStatus.Sold),
        _ => (null, default)
    };

    private async Task TransitionStatus(DealStatus target)
    {
        if (_deal is null) return;

        // Confirmation for significant transitions
        var confirmed = target switch
        {
            DealStatus.Closed => await ConfirmClosingTransition(),
            DealStatus.Sold => await ConfirmSimpleTransition("Mark as Sold", "This will mark the deal as sold and complete the lifecycle. Continue?"),
            DealStatus.UnderContract => await ConfirmSimpleTransition("Move to Under Contract", "This deal will enter the contract phase. Continue?"),
            _ => true
        };

        if (!confirmed) return;

        var previousStatus = _deal.Status;
        try
        {
            await DealService.SetStatusAsync(_deal.Id, target.ToString(), _userId);
            _deal.UpdateStatus(target);
            await ActivityTracker.TrackEventAsync(ActivityEventType.StatusChanged, dealId: _deal.Id,
                metadata: $"{{\"from\":\"{previousStatus}\",\"to\":\"{target}\"}}");
            Snackbar.Add($"Status updated to {GetStatusDisplayName(target)}.", Severity.Success);
            StateHasChanged();
        }
        catch (InvalidOperationException ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
    }

    private async Task<bool> ConfirmSimpleTransition(string title, string message)
    {
        var result = await DialogService.ShowMessageBox(title, message, yesText: "Confirm", cancelText: "Cancel");
        return result == true;
    }

    private async Task<bool> ConfirmClosingTransition()
    {
        var result = await DialogService.ShowMessageBox(
            "Mark as Closed",
            "Enter closing details. The deal will move to the Ownership phase.",
            yesText: "Mark Closed",
            cancelText: "Cancel");

        if (result != true || _deal is null) return false;

        // Set closing fields
        _deal.ClosedDate = DateTime.UtcNow;
        _deal.ActualPurchasePrice ??= _deal.PurchasePrice;
        await Db.SaveChangesAsync();
        return true;
    }
}
