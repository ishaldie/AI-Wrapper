@page "/register"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using ZSR.Underwriting.Application.Validators
@using ZSR.Underwriting.Domain.Entities
@attribute [AllowAnonymous]
@layout Layout.PublicLayout
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager Navigation
@inject IConfiguration Configuration

<PageTitle>Register - ZSR Underwriting</PageTitle>

<div style="display: flex; justify-content: center; padding-top: 4vh;">
    <div style="width: 100%; max-width: 420px;">

        <div style="text-align: center; margin-bottom: 2rem;" class="animate-in">
            <div style="display: inline-flex; align-items: center; gap: 0.625rem; margin-bottom: 1rem;">
                <div class="auth-brand-icon">
                    <MudIcon Icon="@Icons.Material.Filled.Assessment" Size="Size.Small" Style="color: #FFFFFF;" />
                </div>
                <span style="font-size: 1.25rem; font-weight: 700; color: #1A1D23; letter-spacing: -0.02em;">
                    ZSR Underwriting
                </span>
            </div>
        </div>

        <div class="auth-card animate-in delay-1" style="padding: 2rem;">
            <h2 style="font-size: 1.375rem; font-weight: 700; color: #1A1D23; text-align: center; margin: 0 0 0.25rem 0; letter-spacing: -0.02em;">
                Create Account
            </h2>
            <p style="font-size: 0.875rem; color: #6B7280; text-align: center; margin: 0 0 1.5rem 0;">
                Get started with ZSR Underwriting.
            </p>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4" Variant="Variant.Outlined" Dense="true">
                    @_errorMessage
                </MudAlert>
            }

            <EditForm Model="CurrentInput" FormName="register" OnValidSubmit="RegisterUser" method="post">
                <DataAnnotationsValidator />

                <div class="auth-form-group">
                    <label for="reg-name">Full Name</label>
                    <input type="text" id="reg-name" name="Input.FullName"
                           value="@CurrentInput.FullName" placeholder="John Smith" />
                </div>

                <div class="auth-form-group">
                    <label for="reg-email">Email</label>
                    <input type="email" id="reg-email" name="Input.Email"
                           value="@CurrentInput.Email" placeholder="you@@company.com" />
                </div>

                <div class="auth-form-group">
                    <label for="reg-password">Password</label>
                    <input type="password" id="reg-password" name="Input.Password"
                           value="@CurrentInput.Password" placeholder="Create a password" />
                    <div class="field-helper">8+ characters, uppercase, lowercase, digit</div>
                </div>

                <div class="auth-form-group">
                    <label for="reg-confirm">Confirm Password</label>
                    <input type="password" id="reg-confirm" name="Input.ConfirmPassword"
                           value="@CurrentInput.ConfirmPassword" placeholder="Confirm your password" />
                </div>

                <div style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 1.25rem;">
                    <input type="checkbox" id="reg-tos" name="Input.AcceptedTos"
                           value="true"
                           checked="@CurrentInput.AcceptedTos"
                           style="margin-top: 0.2rem; width: 18px; height: 18px; accent-color: #F97316;" />
                    <label for="reg-tos" style="font-size: 0.8125rem; color: #6B7280; cursor: pointer; line-height: 1.5;">
                        I agree to the
                        <a href="/terms" target="_blank" style="color: #F97316; font-weight: 600;">Terms of Service</a>
                        and
                        <a href="/privacy" target="_blank" style="color: #F97316; font-weight: 600;">Privacy Policy</a>.
                    </label>
                </div>

                <MudButton ButtonType="ButtonType.Submit"
                           Variant="Variant.Filled"
                           FullWidth="true"
                           Style="text-transform: none; font-weight: 600; height: 46px; font-size: 0.9375rem; border-radius: 10px; letter-spacing: 0.01em; background: #F97316; color: #FFFFFF;">
                    Create Account
                </MudButton>

                <p style="font-size: 0.875rem; color: #6B7280; text-align: center; margin-top: 1.25rem;">
                    Already have an account?
                    <a href="/login@(QuerySuffix("?q="))" style="color: #F97316; font-weight: 600; text-decoration: none;">Sign in</a>
                </p>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private RegisterInputModel? Input { get; set; }

    [SupplyParameterFromQuery]
    private string? Email { get; set; }

    [SupplyParameterFromQuery(Name = "q")]
    private string? SearchQuery { get; set; }

    private RegisterInputModel CurrentInput => Input ??= new();

    private string? _errorMessage;

    protected override void OnInitialized()
    {
        if (!string.IsNullOrWhiteSpace(Email) && string.IsNullOrWhiteSpace(CurrentInput.Email))
        {
            CurrentInput.Email = Email;
        }
    }

    private string QuerySuffix(string prefix)
    {
        if (string.IsNullOrWhiteSpace(SearchQuery)) return "";
        return prefix + Uri.EscapeDataString(SearchQuery);
    }

    private async Task RegisterUser()
    {
        var validator = new RegisterInputValidator();
        var validation = await validator.ValidateAsync(CurrentInput);
        if (!validation.IsValid)
        {
            _errorMessage = string.Join(" ", validation.Errors.Select(e => e.ErrorMessage));
            return;
        }

        var tosVersion = Configuration["Application:TosVersion"] ?? "1.0";
        var user = new ApplicationUser
        {
            UserName = CurrentInput.Email,
            Email = CurrentInput.Email,
            FullName = CurrentInput.FullName,
            TosAcceptedAt = DateTime.UtcNow,
            TosVersion = tosVersion
        };

        var result = await UserManager.CreateAsync(user, CurrentInput.Password);
        if (!result.Succeeded)
        {
            _errorMessage = string.Join(" ", result.Errors.Select(e => e.Description));
            return;
        }

        await UserManager.AddToRoleAsync(user, "Analyst");
        await SignInManager.SignInAsync(user, isPersistent: false);

        var redirectUrl = string.IsNullOrWhiteSpace(SearchQuery)
            ? "/search"
            : $"/search?q={Uri.EscapeDataString(SearchQuery)}";
        Navigation.NavigateTo(redirectUrl, forceLoad: true);
    }
}
