@page "/login"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using ZSR.Underwriting.Application.Validators
@using ZSR.Underwriting.Domain.Entities
@attribute [AllowAnonymous]
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager Navigation

<PageTitle>Login - ZSR Underwriting</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudPaper Class="pa-6" Elevation="3">
        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-4">Sign In</MudText>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
        }

        <EditForm Model="CurrentInput" FormName="login" OnValidSubmit="LoginUser" method="post">
            <DataAnnotationsValidator />
            <AntiforgeryToken />

            <MudTextField @bind-Value="CurrentInput.Email"
                          Label="Email"
                          InputType="InputType.Email"
                          Variant="Variant.Outlined"
                          Class="mb-3"
                          Required="true"
                          RequiredError="Email is required." />

            <MudTextField @bind-Value="CurrentInput.Password"
                          Label="Password"
                          InputType="InputType.Password"
                          Variant="Variant.Outlined"
                          Class="mb-3"
                          Required="true"
                          RequiredError="Password is required." />

            <MudCheckBox @bind-Value="CurrentInput.RememberMe"
                         Label="Remember me"
                         Class="mb-4"
                         T="bool" />

            <MudButton ButtonType="ButtonType.Submit"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       Class="mb-3">
                Sign In
            </MudButton>

            <MudText Typo="Typo.body2" Align="Align.Center">
                Don't have an account? <MudLink Href="/register">Register</MudLink>
            </MudText>
        </EditForm>
    </MudPaper>
</MudContainer>

@code {
    [SupplyParameterFromForm]
    private LoginInputModel? Input { get; set; }

    private LoginInputModel CurrentInput => Input ??= new();

    private string? _errorMessage;

    private async Task LoginUser()
    {
        var validator = new LoginInputValidator();
        var validation = await validator.ValidateAsync(CurrentInput);
        if (!validation.IsValid)
        {
            _errorMessage = string.Join(" ", validation.Errors.Select(e => e.ErrorMessage));
            return;
        }

        var result = await SignInManager.PasswordSignInAsync(
            CurrentInput.Email, CurrentInput.Password, CurrentInput.RememberMe, lockoutOnFailure: true);

        if (result.IsLockedOut)
        {
            _errorMessage = "Account locked. Please try again later.";
            return;
        }

        if (!result.Succeeded)
        {
            _errorMessage = "Invalid email or password.";
            return;
        }

        Navigation.NavigateTo("/", forceLoad: true);
    }
}
