@page "/deals"
@using ZSR.Underwriting.Application.DTOs
@using ZSR.Underwriting.Application.Interfaces
@using ZSR.Underwriting.Application.Constants
@using ZSR.Underwriting.Domain.Enums
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IDealService DealService
@inject AuthenticationStateProvider AuthStateProvider
@inject IActivityTracker ActivityTracker
@inject NavigationManager Navigation
@inject IDialogService DialogService
@rendermode InteractiveServer

<PageTitle>Deal Pipeline - Underwriting Analyst</PageTitle>

<MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-6">
    <MudStack Spacing="0">
        <MudText Typo="Typo.h4" Style="font-weight: 700; color: #1A2332;">Deal Pipeline</MudText>
        <MudText Typo="Typo.body2" Style="color: #6B7280;">
            Manage and track all underwriting deals.
        </MudText>
    </MudStack>
    <MudButton Variant="Variant.Filled" Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.Add" Href="/search"
               Style="text-transform: none; font-weight: 500;">
        New Deal
    </MudButton>
</MudStack>

@if (_loading)
{
    <MudStack AlignItems="AlignItems.Center" Class="pa-8">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    </MudStack>
}
else
{
    <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #E5E7EB;">
        <MudTextField @bind-Value="_searchText"
                      Placeholder="Search by name or address..."
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Immediate="true"
                      Class="mb-4" />

        <MudStack Spacing="2" Class="mb-4">
            <MudText Typo="Typo.caption" Style="color: #6B7280; font-weight: 600;">ACQUISITION</MudText>
            <MudChipSet T="string" SelectionMode="SelectionMode.MultiSelection" @bind-SelectedValues="_selectedStatuses">
                <MudChip T="string" Value="@("Draft")" Color="Color.Default" Variant="Variant.Outlined">Draft</MudChip>
                <MudChip T="string" Value="@("Screening")" Color="Color.Warning" Variant="Variant.Outlined">Screening</MudChip>
                <MudChip T="string" Value="@("Complete")" Color="Color.Success" Variant="Variant.Outlined">Complete</MudChip>
                <MudChip T="string" Value="@("UnderContract")" Color="Color.Info" Variant="Variant.Outlined">Under Contract</MudChip>
                <MudChip T="string" Value="@("Closed")" Color="Color.Tertiary" Variant="Variant.Outlined">Closed</MudChip>
                <MudChip T="string" Value="@("Active")" Color="Color.Success" Variant="Variant.Outlined">Active</MudChip>
                <MudChip T="string" Value="@("Disposition")" Color="Color.Warning" Variant="Variant.Outlined">Disposition</MudChip>
                <MudChip T="string" Value="@("Sold")" Color="Color.Dark" Variant="Variant.Outlined">Sold</MudChip>
                <MudChip T="string" Value="@("Archived")" Color="Color.Dark" Variant="Variant.Outlined">Archived</MudChip>
            </MudChipSet>
        </MudStack>

        <MudButton Variant="Variant.Outlined"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Compare"
                   Disabled="@(_selectedItems.Count < 2)"
                   OnClick="CompareSelected"
                   Class="mb-4"
                   Style="text-transform: none; font-weight: 500;">
            Compare (@_selectedItems.Count)
        </MudButton>

        @if (!FilteredDeals.Any())
        {
            <MudStack AlignItems="AlignItems.Center" Class="pa-8">
                <MudIcon Icon="@Icons.Material.Outlined.SearchOff" Size="Size.Medium" Style="color: #D1D5DB;" />
                <MudText Typo="Typo.body1" Style="color: #6B7280;">No deals found.</MudText>
            </MudStack>
        }
        else
        {
            <MudDataGrid T="DealSummaryDto" Items="@FilteredDeals" SortMode="SortMode.Single"
                         Hover="true" Elevation="0"
                         MultiSelection="true" @bind-SelectedItems="_selectedItems"
                         RowClick="@(args => Navigation.NavigateTo($"/deals/{args.Item.Id}"))">
                <Columns>
                    <SelectColumn T="DealSummaryDto" ShowInFooter="false" />
                    <PropertyColumn Property="x => x.PropertyName" Title="Property Name" Sortable="true" />
                    <TemplateColumn Title="Type" Sortable="true" SortBy="@(new Func<DealSummaryDto, object>(x => x.PropertyType.ToString()))">
                        <CellTemplate>
                            @if (context.Item.IsSeniorHousing)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                                    @FormatPropertyType(context.Item.PropertyType)
                                </MudChip>
                            }
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.Address" Title="Address" Sortable="true" />
                    <TemplateColumn Title="Status" Sortable="true" SortBy="@(new Func<DealSummaryDto, object>(x => x.Status))">
                        <CellTemplate>
                            <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Item.Status)">
                                @GetStatusDisplayName(context.Item.Status)
                            </MudChip>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Phase" Sortable="true" SortBy="@(new Func<DealSummaryDto, object>(x => x.Phase))">
                        <CellTemplate>
                            <MudText Typo="Typo.body2" Style="color: #6B7280;">@context.Item.Phase</MudText>
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.UpdatedAt" Title="Date" Format="MM/dd/yyyy" Sortable="true" />
                    <TemplateColumn Title="Cap Rate" Sortable="true" SortBy="@(new Func<DealSummaryDto, object>(x => x.CapRate ?? 0m))">
                        <CellTemplate>
                            @FormatPercent(context.Item.CapRate)
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="IRR" Sortable="true" SortBy="@(new Func<DealSummaryDto, object>(x => x.Irr ?? 0m))">
                        <CellTemplate>
                            @FormatPercent(context.Item.Irr)
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Actions" Sortable="false">
                        <CellTemplate>
                            <MudStack Row="true" Spacing="1">
                                <MudIconButton Icon="@Icons.Material.Filled.OpenInNew"
                                               Size="Size.Small"
                                               aria-label="Open"
                                               OnClick="@(() => Navigation.NavigateTo($"/deals/{context.Item.Id}"))" />
                                @if (context.Item.Status != "Archived")
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Archive"
                                                   Size="Size.Small"
                                                   aria-label="Archive"
                                                   OnClick="@(() => ArchiveDeal(context.Item))" />
                                }
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Size="Size.Small"
                                               Color="Color.Error"
                                               aria-label="Delete"
                                               OnClick="@(() => ConfirmDeleteDeal(context.Item))" />
                            </MudStack>
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
            </MudDataGrid>
        }
    </MudPaper>
}

@code {
    private bool _loading = true;
    private List<DealSummaryDto> _deals = new();
    private string _searchText = string.Empty;
    private IReadOnlyCollection<string> _selectedStatuses = Array.Empty<string>();
    private HashSet<DealSummaryDto> _selectedItems = new();
    private string _userId = string.Empty;

    private IEnumerable<DealSummaryDto> FilteredDeals => _deals
        .Where(d => _selectedStatuses.Count == 0 || _selectedStatuses.Contains(d.Status)
            // Treat InProgress as Screening for filter purposes
            || (d.Status == "InProgress" && _selectedStatuses.Contains("Screening")))
        .Where(d => string.IsNullOrWhiteSpace(_searchText)
            || d.PropertyName.Contains(_searchText, StringComparison.OrdinalIgnoreCase)
            || d.Address.Contains(_searchText, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        _userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier) ?? string.Empty;
        var deals = await DealService.GetAllDealsAsync(_userId);
        _deals = deals.ToList();
        _loading = false;
    }

    private void CompareSelected()
    {
        var ids = string.Join(",", _selectedItems.Select(d => d.Id));
        Navigation.NavigateTo($"deals/compare?ids={ids}");
    }

    private async Task ArchiveDeal(DealSummaryDto deal)
    {
        await DealService.SetStatusAsync(deal.Id, "Archived", _userId);
        deal.Status = "Archived";
        StateHasChanged();
    }

    private async Task ConfirmDeleteDeal(DealSummaryDto deal)
    {
        var result = await DialogService.ShowMessageBox(
            "Delete Deal",
            $"Are you sure you want to delete \"{deal.PropertyName}\"? This cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (result == true)
        {
            await DealService.DeleteDealAsync(deal.Id, _userId);
            await ActivityTracker.TrackEventAsync(ActivityEventType.DealDeleted, dealId: deal.Id);
            _deals.Remove(deal);
            _selectedItems.Remove(deal);
            StateHasChanged();
        }
    }

    private static string FormatPercent(decimal? value)
        => value.HasValue ? $"{value.Value * 100:F1}%" : "\u2014";

    private static Color GetStatusColor(string status) => status switch
    {
        "Draft" => Color.Default,
        "InProgress" or "Screening" => Color.Warning,
        "Complete" => Color.Success,
        "Archived" => Color.Dark,
        "UnderContract" => Color.Info,
        "Closed" => Color.Tertiary,
        "Active" => Color.Success,
        "Disposition" => Color.Warning,
        "Sold" => Color.Dark,
        _ => Color.Default
    };

    private static string GetStatusDisplayName(string status) => status switch
    {
        "InProgress" => "Screening",
        "UnderContract" => "Under Contract",
        _ => status
    };

    private static string FormatPropertyType(PropertyType pt) => pt switch
    {
        PropertyType.AssistedLiving => "AL",
        PropertyType.SkilledNursing => "SNF",
        PropertyType.MemoryCare => "MC",
        PropertyType.CCRC => "CCRC",
        _ => "MF"
    };
}
