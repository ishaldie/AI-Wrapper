@page "/accept-terms"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using ZSR.Underwriting.Domain.Entities
@attribute [Authorize]
@layout Layout.PublicLayout
@inject UserManager<ApplicationUser> UserManager
@inject IConfiguration Configuration
@inject NavigationManager Navigation

<PageTitle>Accept Terms of Service - Underwriting Analyst</PageTitle>

<div style="display: flex; justify-content: center; padding-top: 4vh;">
    <div style="width: 100%; max-width: 520px;">

        <div style="text-align: center; margin-bottom: 2rem;" class="animate-in">
            <div style="display: inline-flex; align-items: center; gap: 0.625rem; margin-bottom: 1rem;">
                <div class="auth-brand-icon">
                    <MudIcon Icon="@Icons.Material.Filled.Assessment" Size="Size.Small" Style="color: #FFFFFF;" />
                </div>
                <span style="font-size: 1.25rem; font-weight: 700; color: #1A1D23; letter-spacing: -0.02em;">
                    Underwriting Analyst
                </span>
            </div>
        </div>

        <div class="auth-card animate-in delay-1" style="padding: 2rem;">
            <h2 style="font-size: 1.375rem; font-weight: 700; color: #1A1D23; text-align: center; margin: 0 0 0.25rem 0; letter-spacing: -0.02em;">
                Terms of Service Update
            </h2>
            <p style="font-size: 0.875rem; color: #6B7280; text-align: center; margin: 0 0 1.5rem 0;">
                Please review and accept our terms to continue.
            </p>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4" Variant="Variant.Outlined" Dense="true">
                    @_errorMessage
                </MudAlert>
            }

            <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; font-size: 0.875rem; color: #374151; line-height: 1.6;">
                <p style="margin: 0 0 0.75rem 0;">By using Underwriting Analyst, you agree to:</p>
                <ul style="margin: 0; padding-left: 1.25rem;">
                    <li>Our <a href="/terms" target="_blank" style="color: #F97316; font-weight: 600;">Terms of Service</a> including AI output accuracy disclaimers and limitation of liability.</li>
                    <li>Our <a href="/privacy" target="_blank" style="color: #F97316; font-weight: 600;">Privacy Policy</a> covering how we collect, use, and share your data.</li>
                    <li>Underwriting reports are analytical tools, <strong>not investment advice</strong>.</li>
                </ul>
            </div>

            <EditForm Model="CurrentInput" FormName="accept-terms" OnValidSubmit="HandleAccept" method="post">
                <div style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 1.5rem;">
                    <input type="checkbox" id="accept-tos" name="Input.Accepted"
                           value="true"
                           checked="@CurrentInput.Accepted"
                           style="margin-top: 0.2rem; width: 18px; height: 18px; accent-color: #F97316;" />
                    <label for="accept-tos" style="font-size: 0.875rem; color: #374151; cursor: pointer;">
                        I have read and agree to the
                        <a href="/terms" target="_blank" style="color: #F97316; font-weight: 600;">Terms of Service</a>
                        and
                        <a href="/privacy" target="_blank" style="color: #F97316; font-weight: 600;">Privacy Policy</a>.
                    </label>
                </div>

                <MudButton ButtonType="ButtonType.Submit"
                           Variant="Variant.Filled"
                           FullWidth="true"
                           Style="text-transform: none; font-weight: 600; height: 46px; font-size: 0.9375rem; border-radius: 10px; letter-spacing: 0.01em; background: #F97316; color: #FFFFFF;">
                    Continue to Underwriting Analyst
                </MudButton>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private AcceptTermsInput? Input { get; set; }

    [SupplyParameterFromQuery(Name = "returnUrl")]
    private string? ReturnUrl { get; set; }

    [CascadingParameter]
    private HttpContext? HttpContext { get; set; }

    private AcceptTermsInput CurrentInput => Input ??= new();

    private string? _errorMessage;

    private async Task HandleAccept()
    {
        if (!CurrentInput.Accepted)
        {
            _errorMessage = "You must accept the Terms of Service and Privacy Policy to continue.";
            return;
        }

        var user = HttpContext?.User;
        if (user?.Identity?.IsAuthenticated != true)
        {
            Navigation.NavigateTo("/login", forceLoad: true);
            return;
        }

        var appUser = await UserManager.FindByNameAsync(user.Identity.Name!);
        if (appUser is null)
        {
            Navigation.NavigateTo("/login", forceLoad: true);
            return;
        }

        var tosVersion = Configuration["Application:TosVersion"] ?? "1.0";
        appUser.TosAcceptedAt = DateTime.UtcNow;
        appUser.TosVersion = tosVersion;
        await UserManager.UpdateAsync(appUser);

        var redirect = !string.IsNullOrWhiteSpace(ReturnUrl) ? ReturnUrl : "/search";
        Navigation.NavigateTo(redirect, forceLoad: true);
    }

    public class AcceptTermsInput
    {
        public bool Accepted { get; set; }
    }
}
